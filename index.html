<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fortnite Asset Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /*
        ============================================
        iOS 26 Design Overhaul
        - Font geändert zu 'Inter' für einen cleanen Look.
        - Glassmorphism-Effekt für die meisten UI-Elemente.
        - Sanfte, flüssige Animationen.
        - Helles, luftiges Theme mit einem anpassbaren Akzent.
        ============================================
        */
        :root {
            --accent-color: #007aff; /* Standard iOS Blau */
            --background-start: #1c1c1e;
            --background-end: #000000;
            --text-color: #f5f5f7;
            --text-color-secondary: #8e8e93;
            --card-bg: rgba(44, 44, 46, 0.6);
            --card-bg-solid: rgb(44, 44, 46);
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.2);
            --transition-speed: 0.2s;
        }

        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-start);
            background: linear-gradient(180deg, var(--background-start) 0%, var(--background-end) 100%);
            color: var(--text-color);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .fortnite-font { /* Behalten für Kompatibilität, aber überschrieben */
             font-family: 'Inter', sans-serif;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.4); }

        /* Scrollbar in der Sidebar verstecken */
        #sidebar-links::-webkit-scrollbar { display: none; }
        #sidebar-links { scrollbar-width: none; /* Für Firefox */ }

        /* Glassmorphism Effekt */
        .glass-effect {
            background: var(--card-bg);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 30px var(--shadow-color);
        }

        /* Animationen */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Shimmer Placeholder */
        @keyframes shimmer { 100% { transform: translateX(100%); } }
        .shimmer-bg {
            position: relative; overflow: hidden;
            background-color: rgba(255, 255, 255, 0.05);
        }
        .shimmer-bg::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            transform: translateX(-100%);
            background-image: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.04), transparent);
            animation: shimmer 2.2s infinite;
        }

        /* Loader */
        .loader {
            width: 50px; height: 50px;
            border-radius: 50%;
            display: inline-block;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-top-color: var(--text-color);
            animation: spin 0.8s cubic-bezier(0.6, 0.2, 0.4, 0.8) infinite;
        }
        @keyframes spin { 
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); } 
        }

        /* Buttons */
        .fn-button {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            border: none;
            transition: all var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
        }
        .fn-button:hover:not(:disabled) {
            background-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }
        .fn-button:active:not(:disabled) {
            transform: translateY(0);
        }
        .fn-button.active {
            background-color: var(--accent-color);
            color: white;
            box-shadow: 0 5px 15px color-mix(in srgb, var(--accent-color) 30%, transparent);
        }
        .fn-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            background-color: rgba(255, 255, 255, 0.05);
        }

        /* Card Structure & Hover Glow Effect */
        .fn-card {
            position: relative;
            cursor: pointer;
            border-radius: 22px;
            transition: transform var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            opacity: 0;
            will-change: transform;
        }
        .fn-card-inner {
            background: var(--card-bg);
            backdrop-filter: blur(15px) saturate(150%);
            -webkit-backdrop-filter: blur(15px) saturate(150%);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            overflow: hidden;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative; 
            z-index: 2;
        }
        @property --angle { syntax: "<angle>"; initial-value: 0deg; inherits: false; }
        .fn-card::before {
            content: "";
            position: absolute;
            inset: -3px;
            z-index: 0;
            background: conic-gradient(from var(--angle), transparent 20%, var(--rarity-color, transparent), transparent 80%);
            border-radius: inherit;
            animation: glow-spin 4s linear infinite paused;
            opacity: 0;
            transition: opacity 0.4s ease-out;
            filter: blur(12px);
        }
        .fn-card::after {
            content: "";
            position: absolute;
            inset: 0;
            background: var(--card-bg-solid);
            border-radius: 20px;
            z-index: 1;
        }
        .fn-card:hover { transform: translateY(-8px) scale(1.03); }
        .fn-card:hover::before { opacity: 1; animation-play-state: running; }
        @keyframes glow-spin { to { --angle: 360deg; } }
        .card-action {
            opacity: 0;
            transition: opacity var(--transition-speed) ease;
            pointer-events: none;
        }
        .fn-card:hover .card-action { 
            opacity: 1;
            pointer-events: auto;
        }

        /* Modal */
        .modal-backdrop {
            background-color: rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            transition: opacity var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal-content { animation: scaleIn var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* Checkbox & Toggles */
        .fn-checkbox {
            appearance: none; width: 22px; height: 22px;
            border: 2px solid #c7c7cc;
            border-radius: 6px; position: relative;
            cursor: pointer; outline: none; transition: all 0.2s ease;
        }
        .fn-checkbox:checked { background-color: var(--accent-color); border-color: var(--accent-color); }
        .fn-checkbox:checked::after {
            content: '✓'; font-size: 16px; color: white;
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
        }
        .ios-toggle .dot { transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .ios-toggle input ~ div:first-of-type { background-color: #39393d; }
        .ios-toggle input:checked ~ .dot { transform: translateX(100%); }
        .ios-toggle input:checked ~ div:first-of-type { background-color: #34c759; }
        
        /* Sidebar Nav */
        #sidebar-nav {
            transition: all var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
            width: 56px; border-radius: 28px; padding: 8px;
            overflow: hidden; animation: fadeIn 0.5s ease;
        }
        #sidebar-nav:hover { width: 250px; border-radius: 20px; padding: 16px; }
        #sidebar-links .link-text {
            opacity: 0; transition: opacity 0.2s ease, width 0.2s ease;
            transition-delay: 0.05s; width: 0; overflow: hidden;
        }
        #sidebar-nav:hover .link-text { opacity: 1; width: auto; margin-left: 1rem; }
        #sidebar-links .sidebar-link {
            transition: background-color 0.2s ease;
            color: var(--text-color-secondary); font-weight: 500; justify-content: center;
        }
        #sidebar-nav:hover #sidebar-links .sidebar-link { justify-content: flex-start; }
        #sidebar-links .sidebar-link:hover { background-color: rgba(255, 255, 255, 0.05); color: var(--text-color); }
        #sidebar-links .sidebar-link.active { color: var(--text-color); background-color: rgba(255, 255, 255, 0.1); }
        #sidebar-links .sidebar-link .dot {
            width: 8px; height: 8px; transition: all 0.2s ease;
            background-color: var(--text-color-secondary); flex-shrink: 0;
        }
        #sidebar-links .sidebar-link:hover .dot, #sidebar-links .sidebar-link.active .dot {
            background-color: var(--accent-color); transform: scale(1.3);
            box-shadow: 0 0 8px var(--accent-color);
        }
        
        /* New Badge */
        .new-badge {
            position: absolute; top: 12px; left: 12px;
            background-color: var(--accent-color);
            color: white; padding: 3px 10px; border-radius: 8px;
            font-size: 0.8rem; font-weight: 600; text-transform: uppercase; z-index: 10;
        }

        /* Inputs & Custom Select */
        .ios-input, .ios-textarea {
            background-color: rgba(255, 255, 255, 0.08);
            border: none; border-radius: 10px; transition: all 0.2s ease;
            color: var(--text-color);
        }
        .ios-input:hover, .ios-textarea:hover { background-color: rgba(255, 255, 255, 0.12); }
        .ios-input:focus, .ios-textarea:focus {
             background-color: rgba(255, 255, 255, 0.12);
             box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent-color) 40%, transparent);
             outline: none;
        }
        
        .custom-select-container { position: relative; width: 100%; }
        .custom-select-trigger {
            cursor: pointer; padding: 0.5rem; display: flex;
            justify-content: space-between; align-items: center;
        }
        .custom-select-trigger::after {
            content: '▾'; color: var(--text-color-secondary);
        }
        .custom-select-options {
            position: absolute; top: calc(100% + 4px); left: 0; right: 0;
            z-index: 10; border-radius: 10px; overflow: hidden;
            display: none; animation: fadeIn 0.1s ease-out;
        }
        .custom-select-options.open { display: block; }
        .custom-select-option {
            padding: 0.5rem; cursor: pointer;
            background-color: var(--card-bg-solid);
        }
        .custom-select-option:hover, .custom-select-option.selected {
            background-color: var(--accent-color);
            color: white;
        }

        /* Toast & ScrollToTop */
        #toast-notification { animation: scaleIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #scrollToTopBtn {
            opacity: 0; transform: translateY(20px); pointer-events: none;
            transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1), transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #scrollToTopBtn.show { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .no-scroll { overflow: hidden; }
        .share-buttons-hidden .share-btn { display: none; }
        #shop-countdown-container.hidden { display: none; }

        /* Variant Image & Shine Effect */
        .variant-image-container { position: relative; width: 100%; height: 100%; overflow: hidden; }
        .variant-image {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: contain;
            transition: opacity 0.7s ease-in-out; opacity: 0;
        }
        .variant-image.active { opacity: 1; }
        .variant-image-container::after {
            content: '';
            position: absolute;
            top: -10%; 
            left: 0;
            width: 30%;
            height: 120%;
            background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0) 100%);
            transform: translateX(-200%) skewX(-25deg);
            z-index: 5;
            pointer-events: none;
        }
        .variant-image-container.shine-active::after {
            animation: shine-sweep 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes shine-sweep {
            from { transform: translateX(-200%) skewX(-25deg); }
            to { transform: translateX(400%) skewX(-25deg); }
        }

        .color-swatch { transition: all 0.2s ease-in-out; }
        .color-swatch.selected {
            transform: scale(1.15);
            box-shadow: 0 0 0 3px var(--text-color), 0 0 0 5px var(--accent-color);
        }

        /* Admin Panel Tabs */
        .admin-tab {
            padding: 8px 16px;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px; /* Overlap the main border */
            transition: all 0.2s ease;
        }
        .admin-tab.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }
        .admin-tab:not(.active):hover {
            color: var(--text-color);
            background-color: rgba(255, 255, 255, 0.05);
        }

        /* Mobile Warning Overlay */
        #mobile-warning-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999; /* Highest z-index */
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(15px);
            overflow: hidden;
            padding: 1rem;
        }

        .warning-container {
            padding: 2rem;
            border-radius: 1.5rem;
            text-align: center;
            max-width: 90%;
            position: relative;
            z-index: 2;
        }

        .warning-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffdd00; /* Cyberpunk Yellow */
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 0.5rem;
            text-shadow: 0 0 10px #ffdd00, 0 0 5px #ff5555;
        }

        .warning-text {
            font-size: 1rem;
            color: var(--text-color);
        }

        .warning-tape {
            position: absolute;
            width: 200%;
            height: 50px;
            background: repeating-linear-gradient(
                -45deg,
                rgba(255, 220, 0, 0.7),
                rgba(255, 220, 0, 0.7) 25px,
                transparent 25px,
                transparent 50px
            );
            animation: move-tape 10s linear infinite;
            z-index: 1;
            border-top: 1px solid rgba(255, 220, 0, 0.8);
            border-bottom: 1px solid rgba(255, 220, 0, 0.8);
        }

        .tape1 { top: 25%; transform: rotate(-15deg); }
        .tape2 { bottom: 25%; transform: rotate(-15deg); }

        @keyframes move-tape {
            from { background-position: 0 0; }
            to { background-position: -200px 0; }
        }

        /* Hide warning on larger screens */
        @media (min-width: 768px) {
            #mobile-warning-overlay {
                display: none;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Global Announcement Banner -->
    <div id="global-announcement-banner" class="hidden relative bg-gradient-to-r from-[var(--accent-color)] to-blue-500 text-white text-center p-3 font-medium">
        <span id="announcement-text"></span>
        <button id="close-announcement" class="absolute top-1/2 right-4 -translate-y-1/2 text-2xl font-bold text-white/80 hover:text-white">&times;</button>
    </div>

    <!-- Mobile Warning Overlay -->
    <div id="mobile-warning-overlay">
        <div class="warning-tape tape1"></div>
        <div class="warning-container glass-effect">
            <h2 class="warning-title">SYSTEM WARNUNG</h2>
            <p class="warning-text">Diese Ansicht wird zurzeit für mobile Geräte optimiert.</p>
        </div>
        <div class="warning-tape tape2"></div>
    </div>

    <!-- Sidebar Navigation -->
    <nav id="sidebar-nav" class="hidden glass-effect fixed top-1/2 -translate-y-1/2 left-4 z-40">
        <div id="sidebar-links" class="flex flex-col gap-0 items-start h-full max-h-[80vh] overflow-y-auto overflow-x-hidden">
            <!-- Links werden hier dynamisch eingefügt -->
        </div>
    </nav>

    <div class="container mx-auto p-4 md:p-6">
        <!-- Sticky Header mit Glass-Effekt -->
        <div class="sticky top-4 glass-effect z-30 py-3 px-4 mb-6 rounded-2xl">
            <div class="flex flex-col md:flex-row gap-4 justify-between items-center">
                <div>
                    <h1 class="text-xl sm:text-2xl font-bold" data-translate="title">FORTNITE ASSET EXPLORER</h1>
                </div>
                <div class="flex gap-2 p-1 bg-black/20 rounded-lg">
                    <button id="tab-all" class="fn-button active px-5 py-1.5 rounded-md text-sm" data-translate="tabAll">Alle Assets</button>
                    <button id="tab-shop" class="fn-button px-5 py-1.5 rounded-md text-sm" data-translate="tabShop">Item-Shop</button>
                </div>
                <div class="flex flex-col sm:flex-row items-center gap-3 w-full md:w-auto">
                    <input type="text" id="search-input" placeholder="Suchen..." class="ios-input px-4 py-2 w-full md:w-64 focus:outline-none transition-colors text-white placeholder-gray-400">
                    <button id="filter-button" class="fn-button px-5 py-2 rounded-lg" data-translate="filterButton">Filter</button>
                    <div class="relative">
                        <button id="settings-button" class="fn-button p-2.5 rounded-lg flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311a1.464 1.464 0 0 1-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c-1.4-.413-1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.858 2.929 2.929 0 0 1 0 5.858z"/>
                            </svg>
                        </button>
                        <div id="settings-menu" class="hidden absolute top-full right-0 mt-2 glass-effect rounded-2xl p-4 z-50 w-72">
                            <!-- iOS Toggles -->
                            <label for="variant-cycle-toggle" class="ios-toggle flex items-center justify-between gap-4 cursor-pointer">
                                <span data-translate="settingsAutoCycle" class="font-medium">Auto-Stilwechsel</span>
                                <div class="relative">
                                    <input type="checkbox" id="variant-cycle-toggle" class="sr-only">
                                    <div class="block w-12 h-7 rounded-full transition"></div>
                                    <div class="dot absolute left-1 top-1 bg-white w-5 h-5 rounded-full"></div>
                                </div>
                            </label>
                            <hr class="border-white/10 my-3">
                             <label for="share-button-toggle" class="ios-toggle flex items-center justify-between gap-4 cursor-pointer">
                                <span data-translate="settingsShowShareButton" class="font-medium">Teilen-Button</span>
                                <div class="relative">
                                    <input type="checkbox" id="share-button-toggle" class="sr-only">
                                    <div class="block w-12 h-7 rounded-full transition"></div>
                                    <div class="dot absolute left-1 top-1 bg-white w-5 h-5 rounded-full"></div>
                                </div>
                            </label>
                            <hr class="border-white/10 my-3">
                             <label for="shop-countdown-toggle" class="ios-toggle flex items-center justify-between gap-4 cursor-pointer">
                                <span data-translate="settingsShowCountdownAlways" class="font-medium">Countdown immer</span>
                                <div class="relative">
                                    <input type="checkbox" id="shop-countdown-toggle" class="sr-only">
                                    <div class="block w-12 h-7 rounded-full transition"></div>
                                    <div class="dot absolute left-1 top-1 bg-white w-5 h-5 rounded-full"></div>
                                </div>
                            </label>
                            <hr class="border-white/10 my-3">
                             <label for="sounds-toggle" class="ios-toggle flex items-center justify-between gap-4 cursor-pointer">
                                <span data-translate="settingsSounds" class="font-medium">UI-Sounds</span>
                                <div class="relative">
                                    <input type="checkbox" id="sounds-toggle" class="sr-only">
                                    <div class="block w-12 h-7 rounded-full transition"></div>
                                    <div class="dot absolute left-1 top-1 bg-white w-5 h-5 rounded-full"></div>
                                </div>
                            </label>
                            <!-- Other settings -->
                            <div class="space-y-2 mt-4">
                                <span class="font-medium" data-translate="settingsAccentColor">Akzentfarbe</span>
                                <div id="color-picker" class="flex justify-between gap-3 pt-1">
                                    <button class="color-swatch w-9 h-9 rounded-full border-2 border-transparent" style="background-color: #007aff;" data-color="#007aff" title="iOS Blau"></button>
                                    <button class="color-swatch w-9 h-9 rounded-full border-2 border-transparent" style="background-color: #ff9500;" data-color="#ff9500" title="iOS Orange"></button>
                                    <button class="color-swatch w-9 h-9 rounded-full border-2 border-transparent" style="background-color: #34c759;" data-color="#34c759" title="iOS Grün"></button>
                                    <button class="color-swatch w-9 h-9 rounded-full border-2 border-transparent" style="background-color: #af52de;" data-color="#af52de" title="iOS Lila"></button>
                                </div>
                            </div>
                            <div class="space-y-2 mt-4">
                               <label for="new-badge-duration" class="font-medium" data-translate="settingsNewBadge">"Neu"-Anzeige für</label>
                               <select id="new-badge-duration" class="w-full hidden"></select>
                            </div>
                            <div class="space-y-2 mt-4">
                               <label for="variant-cycle-speed" class="font-medium" data-translate="settingsCycleSpeed">Stilwechsel-Tempo</label>
                               <select id="variant-cycle-speed" class="w-full hidden"></select>
                           </div>
                            <div class="space-y-2 mt-4">
                               <label for="language-select" class="font-medium" data-translate="settingsLanguage">Sprache</label>
                               <select id="language-select" class="w-full hidden">
                                   <option value="de">Deutsch</option>
                                   <option value="en" selected>English</option>
                                   <option value="es">Español</option>
                               </select>
                           </div>
                        </div>
                    </div>
                    <div class="relative">
                        <button id="profile-button" class="fn-button p-2.5 rounded-lg flex items-center justify-center">
                            <svg id="logged-out-icon" xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6Zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0Zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4Zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
                            </svg>
                            <svg id="logged-in-icon" xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-person-fill hidden" viewBox="0 0 16 16">
                                <path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
                            </svg>
                        </button>
                        <div id="auth-dropdown" class="hidden absolute top-full right-0 mt-2 glass-effect rounded-2xl p-2 z-50 w-48">
                           <div id="user-email" class="px-2 py-1.5 text-sm text-gray-400 truncate"></div>
                           <hr class="border-white/10 my-1">
                           <button id="admin-panel-button" class="hidden w-full text-left px-2 py-1.5 rounded-lg hover:bg-white/10 transition-colors">Admin Panel</button>
                           <hr id="admin-hr" class="hidden border-white/10 my-1">
                           <button id="logout-button" class="w-full text-left px-2 py-1.5 rounded-lg hover:bg-white/10 transition-colors">Logout</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="item-count-wrapper" class="text-center text-sm text-[var(--text-color-secondary)] mt-3 flex justify-center items-center gap-4">
                <span id="item-count"></span>
                <div id="shop-countdown-container" class="hidden">
                    <span data-translate="countdownLabel">Shop wechselt in:</span>
                    <span id="shop-countdown" class="font-semibold text-[var(--text-color)]"></span>
                </div>
            </div>
        </div>

        <div id="loader" class="flex justify-center items-center py-20"><div class="loader"></div></div>
        <div id="grid-container" class="relative">
            <div id="item-grid"></div>
            <div id="sentinel"></div> <!-- Sentinel for infinite scroll -->
            <!-- Glasige Ladeschnecke für Shop-Updates -->
            <div id="shop-loader-overlay" class="hidden absolute inset-0 z-20 glass-effect flex justify-center items-center rounded-2xl">
                <div class="loader"></div>
            </div>
        </div>
    </div>

    <!-- Filter Modal -->
    <div id="filter-modal" class="hidden fixed inset-0 z-50 flex justify-center items-center modal-backdrop opacity-0">
        <div class="glass-effect modal-content p-8 rounded-3xl w-full max-w-2xl">
            <h2 class="text-2xl font-bold mb-6 text-center" data-translate="filterTitle">Filtern</h2>
            <div id="type-filter-container" class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-8">
                <!-- Checkboxen werden hier eingefügt -->
            </div>
            <hr class="border-white/10 my-6">
            <div class="flex justify-center mb-8">
                 <label class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" id="new-items-filter" class="fn-checkbox">
                    <span data-translate="filterNewOnly">Nur neue Gegenstände anzeigen</span>
                </label>
            </div>
            <div class="flex justify-center gap-4">
                 <button id="apply-filters" class="fn-button active px-8 py-3 rounded-xl text-base" data-translate="filterApply">Anwenden</button>
                 <button id="close-modal" class="fn-button px-8 py-3 rounded-xl text-base" data-translate="filterClose">Schließen</button>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="hidden fixed inset-0 z-50 flex justify-center items-center modal-backdrop opacity-0 p-4">
        <div class="glass-effect modal-content p-8 rounded-3xl w-full max-w-sm relative">
            <button id="close-auth-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>
            </button>
            
            <!-- Login Form -->
            <div id="login-view">
                <h2 class="text-2xl font-bold text-center mb-6">Login</h2>
                <form id="login-form" class="space-y-4">
                    <input type="email" id="login-email" placeholder="E-Mail" class="ios-input w-full px-4 py-3" required>
                    <input type="password" id="login-password" placeholder="Passwort" class="ios-input w-full px-4 py-3" required>
                    <button type="submit" class="fn-button active w-full py-3 rounded-xl">Anmelden</button>
                </form>
                <p id="login-error" class="text-red-500 text-sm text-center mt-4 h-4"></p>
                <p class="text-center mt-4 text-sm">
                    Noch kein Account? <button id="show-register-view" class="font-semibold text-[var(--accent-color)] hover:underline">Registrieren</button>
                </p>
            </div>

            <!-- Register Form -->
            <div id="register-view" class="hidden">
                 <h2 class="text-2xl font-bold text-center mb-6">Registrieren</h2>
                <form id="register-form" class="space-y-4">
                    <input type="email" id="register-email" placeholder="E-Mail" class="ios-input w-full px-4 py-3" required>
                    <input type="password" id="register-password" placeholder="Passwort (min. 6 Zeichen)" class="ios-input w-full px-4 py-3" required>
                    <button type="submit" class="fn-button active w-full py-3 rounded-xl">Account erstellen</button>
                </form>
                <p id="register-error" class="text-red-500 text-sm text-center mt-4 h-4"></p>
                 <p class="text-center mt-4 text-sm">
                    Bereits einen Account? <button id="show-login-view" class="font-semibold text-[var(--accent-color)] hover:underline">Anmelden</button>
                </p>
            </div>
        </div>
    </div>
    
    <!-- Item Detail Modal -->
    <div id="item-detail-modal" class="hidden fixed inset-0 z-50 flex justify-center items-center modal-backdrop opacity-0 p-4">
        <div class="glass-effect modal-content p-6 sm:p-8 rounded-3xl w-full max-w-4xl relative">
            <button id="close-detail-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                </svg>
            </button>
            <div id="detail-content-wrapper" class="grid md:grid-cols-2 gap-6 sm:gap-8 max-h-[85vh] overflow-y-auto">
                <div id="detail-image-container" class="aspect-square rounded-2xl shimmer-bg flex items-center justify-center">
                    <img id="detail-image" src="" alt="Item Image" class="w-full h-full object-contain opacity-0 transition-opacity duration-500">
                </div>
                <div class="flex flex-col">
                    <h2 id="detail-name" class="text-3xl sm:text-4xl font-bold mb-1">Item Name</h2>
                    <p id="detail-rarity" class="text-lg font-semibold mb-4" style="color: var(--rarity-color);">Rarity</p>
                    <p id="detail-description" class="text-base text-gray-300 mb-6">Description...</p>
                    <hr class="border-white/10 my-2">
                    <div id="detail-stats" class="space-y-3 pt-4">
                        <!-- Stats werden hier dynamisch eingefügt -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div id="admin-panel-modal" class="hidden fixed inset-0 z-50 flex justify-center items-center modal-backdrop opacity-0 p-4">
        <div class="glass-effect modal-content p-6 sm:p-8 rounded-3xl w-full max-w-7xl relative max-h-[90vh] flex flex-col">
            <button id="close-admin-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors z-20">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>
            </button>
            <h2 class="text-2xl font-bold text-center mb-4 flex-shrink-0">Admin Panel</h2>
            <div class="flex border-b border-white/10 mb-4 flex-shrink-0">
                <button data-tab="dashboard" class="admin-tab active font-medium">Dashboard</button>
                <button data-tab="users" class="admin-tab font-medium">Benutzer</button>
                <button data-tab="analytics" class="admin-tab font-medium">Analyse</button>
            </div>
            <div class="overflow-y-auto flex-grow pr-2 -mr-4">
                <div id="admin-dashboard-tab" class="admin-tab-content space-y-8">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="glass-effect p-4 rounded-2xl flex flex-col"><h3 class="text-lg font-semibold text-center text-gray-300 mb-2">Besucher-Trend (Letzte 7 Tage)</h3><div class="flex-grow min-h-[250px]"><canvas id="visits-trend-chart"></canvas></div></div>
                        <div class="glass-effect p-4 rounded-2xl flex flex-col"><h3 class="text-lg font-semibold text-center text-gray-300 mb-2">Besucher nach Land</h3><div class="flex items-center justify-center flex-grow"><div class="w-full max-w-[250px] h-[250px]"><canvas id="country-chart"></canvas></div></div></div>
                    </div>
                    <div class="glass-effect p-4 rounded-2xl"><h3 class="text-lg font-semibold text-gray-300 mb-2">Globale Ankündigung</h3><textarea id="announcement-input" class="ios-textarea w-full p-2 h-20" placeholder="Schreibe eine Ankündigung..."></textarea><button id="save-announcement-btn" class="fn-button active w-full mt-2 py-2 rounded-lg">Speichern & Anzeigen</button></div>
                </div>
                <div id="admin-users-tab" class="admin-tab-content hidden"><h3 class="text-lg font-semibold text-gray-300 mb-2">Benutzerverwaltung</h3><div id="user-list-container" class="max-h-[60vh] overflow-y-auto"></div></div>
                <div id="admin-analytics-tab" class="admin-tab-content hidden space-y-8">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="glass-effect p-4 rounded-2xl"><h3 class="text-lg font-semibold text-gray-300 mb-2">Top Suchanfragen</h3><div id="top-searches-container" class="max-h-80 overflow-y-auto text-sm pr-2"></div></div>
                        <div class="glass-effect p-4 rounded-2xl"><h3 class="text-lg font-semibold text-gray-300 mb-2">Meistgenutzte Filter</h3><div class="flex-grow min-h-[250px]"><canvas id="filter-usage-chart"></canvas></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- User Detail Modal -->
    <div id="user-detail-modal" class="hidden fixed inset-0 z-50 flex justify-center items-center modal-backdrop opacity-0 p-4">
        <div class="glass-effect modal-content p-8 rounded-3xl w-full max-w-lg relative">
            <button id="close-user-detail-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>
            </button>
            <h2 class="text-2xl font-bold text-center mb-6">Benutzerdetails</h2>
            <div id="user-detail-content" class="space-y-3"></div>
        </div>
    </div>


    <button id="scrollToTopBtn" class="fixed bottom-8 right-8 glass-effect w-14 h-14 rounded-full flex items-center justify-center text-2xl z-30 font-bold">
        &uarr;
    </button>
    
    <div id="toast-notification" class="fixed bottom-8 left-1/2 -translate-x-1/2 glass-effect px-6 py-3 rounded-xl shadow-lg opacity-0 transform translate-y-4">
        Link kopiert!
    </div>
        
    <audio id="audio-player" class="hidden"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, getDocs, orderBy, limit, updateDoc, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    document.addEventListener('DOMContentLoaded', () => {
            const itemGrid = document.getElementById('item-grid');
            const searchInput = document.getElementById('search-input');
            const loader = document.getElementById('loader');
            const tabAll = document.getElementById('tab-all');
            const tabShop = document.getElementById('tab-shop');
            const itemCount = document.getElementById('item-count');
            const filterButton = document.getElementById('filter-button');
            const filterModal = document.getElementById('filter-modal');
            const closeModalBtn = document.getElementById('close-modal');
            const applyFiltersBtn = document.getElementById('apply-filters');
            const typeFilterContainer = document.getElementById('type-filter-container');
            const newItemsFilter = document.getElementById('new-items-filter');
            const sidebarNav = document.getElementById('sidebar-nav');
            const sidebarLinks = document.getElementById('sidebar-links');
            const sentinel = document.getElementById('sentinel');
            const audioPlayer = document.getElementById('audio-player');
            const scrollToTopBtn = document.getElementById('scrollToTopBtn');
            const toast = document.getElementById('toast-notification');
            const settingsButton = document.getElementById('settings-button');
            const settingsMenu = document.getElementById('settings-menu');
            const variantCycleToggle = document.getElementById('variant-cycle-toggle');
            const colorPicker = document.getElementById('color-picker');
            const newBadgeDurationSelect = document.getElementById('new-badge-duration');
            const variantCycleSpeedSelect = document.getElementById('variant-cycle-speed');
            const languageSelect = document.getElementById('language-select');
            const shareButtonToggle = document.getElementById('share-button-toggle');
            const shopCountdownToggle = document.getElementById('shop-countdown-toggle');
            const soundsToggle = document.getElementById('sounds-toggle');
            const shopCountdownContainer = document.getElementById('shop-countdown-container');
            const shopCountdown = document.getElementById('shop-countdown');
            const shopLoaderOverlay = document.getElementById('shop-loader-overlay');
            const itemDetailModal = document.getElementById('item-detail-modal');
            const closeDetailModal = document.getElementById('close-detail-modal');
            const detailName = document.getElementById('detail-name');
            const detailRarity = document.getElementById('detail-rarity');
            const detailDescription = document.getElementById('detail-description');
            const detailImage = document.getElementById('detail-image');
            const detailImageContainer = document.getElementById('detail-image-container');
            const detailStats = document.getElementById('detail-stats');
            const profileButton = document.getElementById('profile-button');
            const loggedOutIcon = document.getElementById('logged-out-icon');
            const loggedInIcon = document.getElementById('logged-in-icon');
            const authModal = document.getElementById('auth-modal');
            const closeAuthModalBtn = document.getElementById('close-auth-modal');
            const loginView = document.getElementById('login-view');
            const registerView = document.getElementById('register-view');
            const showRegisterViewBtn = document.getElementById('show-register-view');
            const showLoginViewBtn = document.getElementById('show-login-view');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const loginError = document.getElementById('login-error');
            const registerError = document.getElementById('register-error');
            const authDropdown = document.getElementById('auth-dropdown');
            const userEmailDisplay = document.getElementById('user-email');
            const logoutButton = document.getElementById('logout-button');
            
            // Admin Panel Elements
            const adminPanelButton = document.getElementById('admin-panel-button');
            const adminHr = document.getElementById('admin-hr');
            const adminPanelModal = document.getElementById('admin-panel-modal');
            const closeAdminModal = document.getElementById('close-admin-modal');
            const countryChartCanvas = document.getElementById('country-chart');
            const visitsTrendChartCanvas = document.getElementById('visits-trend-chart');
            const userListContainer = document.getElementById('user-list-container');
            const announcementInput = document.getElementById('announcement-input');
            const saveAnnouncementBtn = document.getElementById('save-announcement-btn');
            const adminTabs = document.querySelectorAll('.admin-tab');
            const adminTabContents = document.querySelectorAll('.admin-tab-content');
            const topSearchesContainer = document.getElementById('top-searches-container');
            const filterUsageChartCanvas = document.getElementById('filter-usage-chart');

            // User Detail Modal Elements
            const userDetailModal = document.getElementById('user-detail-modal');
            const closeUserDetailModal = document.getElementById('close-user-detail-modal');
            const userDetailContent = document.getElementById('user-detail-content');

            // Global Announcement Banner Elements
            const announcementBanner = document.getElementById('global-announcement-banner');
            const announcementText = document.getElementById('announcement-text');
            const closeAnnouncementBtn = document.getElementById('close-announcement');


            sidebarNav.addEventListener('mouseenter', () => document.body.classList.add('no-scroll'));
            sidebarNav.addEventListener('mouseleave', () => document.body.classList.remove('no-scroll'));

            let apiKey = '69eac605-420ddfb7-ad6d74d2-7244a7cb';
            let allAssets = [];
            let filteredAssets = [];
            let currentlyDisplayedItems = 0;
            const ITEMS_PER_LOAD = 60;
            let shopData = null;
            let currentView = 'all';
            let debounceTimer;
            let lastAppliedFilterTypes = [];
            let lastAppliedShowOnlyNew = false;
            let countdownInterval = null;
            let lastShopUpdate = null;
            let visitsListener = null; 
            let usersListener = null;
            let analyticsListener = null;
            
            const translations = {
                en: {
                    title: "FORTNITE ASSET EXPLORER", tabAll: "All Assets", tabShop: "Item Shop", searchPlaceholder: "Search...", filterButton: "Filter",
                    itemCount: (c) => `${c} items found`, itemCountShop: (c) => `${c} items in shop`, newBadge: "New", filterTitle: "Filter",
                    filterNewOnly: "Show new items only", filterApply: "Apply", filterClose: "Close", settingsAutoCycle: "Auto-Cycle Styles",
                    settingsAccentColor: "Accent Color", settingsNewBadge: `"New" Badge For`, settingsCycleSpeed: "Cycle Speed", settingsLanguage: "Language",
                    settingsShowShareButton: "Show Share Button", settingsShowCountdownAlways: "Always show countdown", countdownLabel: "Shop resets in:",
                    linkCopied: "Link copied!", statsLastSeen: "Last Seen", statsOccurrences: "Occurrences", statsFirstSeen: "First Seen",
                    statsNotAvailable: "Not available in the Item Shop.", settingsSounds: "UI Sounds",
                    announcementSaved: "Announcement saved!", userActionSuccess: "User updated successfully!",
                    typeOptions: { "outfit": "Outfits", "emote": "Emotes", "pickaxe": "Pickaxes", "glider": "Gliders", "backpack": "Back Blings", "wrap": "Wraps", "music": "Music", "loadingscreen": "Loading Screens", "jamtrack": "Jam Tracks" },
                    newBadgeOptions: { "3": "3 Days", "7": "7 Days", "14": "14 Days", "0": "Never Show" },
                    cycleSpeedOptions: { "1000": "1 Second (Fast)", "1500": "1.5 Seconds (Normal)", "2500": "2.5 Seconds (Slow)" }
                },
                de: {
                    title: "FORTNITE ASSET EXPLORER", tabAll: "Alle Assets", tabShop: "Item-Shop", searchPlaceholder: "Suchen...", filterButton: "Filter",
                    itemCount: (c) => `${c} Gegenstände`, itemCountShop: (c) => `${c} Gegenstände im Shop`, newBadge: "Neu", filterTitle: "Filtern",
                    filterNewOnly: "Nur neue Gegenstände anzeigen", filterApply: "Anwenden", filterClose: "Schließen", settingsAutoCycle: "Auto-Stilwechsel",
                    settingsAccentColor: "Akzentfarbe", settingsNewBadge: `"Neu"-Anzeige für`, settingsCycleSpeed: "Stilwechsel-Tempo", settingsLanguage: "Sprache",
                    settingsShowShareButton: "Teilen-Button", settingsShowCountdownAlways: "Countdown immer", countdownLabel: "Shop wechselt in:",
                    linkCopied: "Link kopiert!", statsLastSeen: "Zuletzt im Shop", statsOccurrences: "Anzahl im Shop", statsFirstSeen: "Erstmals erschienen",
                    statsNotAvailable: "Nicht im Item-Shop erhältlich.", settingsSounds: "UI-Sounds",
                    announcementSaved: "Ankündigung gespeichert!", userActionSuccess: "Benutzer erfolgreich aktualisiert!",
                    typeOptions: { "outfit": "Outfits", "emote": "Emotes", "pickaxe": "Spitzhacken", "glider": "Hängegleiter", "backpack": "Rücken-Accessoires", "wrap": "Lackierungen", "music": "Musik", "loadingscreen": "Ladebildschirme", "jamtrack": "Jam-Tracks" },
                    newBadgeOptions: { "3": "3 Tage", "7": "7 Tage", "14": "14 Tage", "0": "Nie anzeigen" },
                    cycleSpeedOptions: { "1000": "1 Sekunde (Schnell)", "1500": "1.5 Sekunden (Normal)", "2500": "2.5 Sekunden (Langsam)" }
                },
                es: {
                    title: "EXPLORADOR DE ASSETS DE FORTNITE", tabAll: "Todos los Assets", tabShop: "Tienda de Objetos", searchPlaceholder: "Buscar...", filterButton: "Filtros",
                    itemCount: (c) => `${c} objetos encontrados`, itemCountShop: (c) => `${c} objetos en la tienda`, newBadge: "Nuevo", filterTitle: "Filtros",
                    filterNewOnly: "Mostrar solo nuevos", filterApply: "Aplicar", filterClose: "Cerrar", settingsAutoCycle: "Rotación auto. de estilos",
                    settingsAccentColor: "Color de acento", settingsNewBadge: `Mostrar "Nuevo" por`, settingsCycleSpeed: "Velocidad de rotación", settingsLanguage: "Idioma",
                    settingsShowShareButton: "Mostrar botón de compartir", settingsShowCountdownAlways: "Mostrar siempre cuenta atrás",
                    countdownLabel: "La tienda se reinicia en:", linkCopied: "¡Enlace copiado!", statsLastSeen: "Visto por última vez",
                    statsOccurrences: "Apariciones", statsFirstSeen: "Visto por primera vez", statsNotAvailable: "No disponible en la Tienda de Objetos.",
                    settingsSounds: "Sonidos de UI",
                    announcementSaved: "¡Anuncio guardado!", userActionSuccess: "¡Usuario actualizado con éxito!",
                    typeOptions: { "outfit": "Trajes", "emote": "Gestos", "pickaxe": "Picos", "glider": "Ala deltas", "backpack": "Mochilas", "wrap": "Envoltorios", "music": "Música", "loadingscreen": "Pantallas de carga", "jamtrack": "Pistas de improvisación" },
                    newBadgeOptions: { "3": "3 días", "7": "7 días", "14": "14 días", "0": "Nunca mostrar" },
                    cycleSpeedOptions: { "1000": "1 segundo (Rápido)", "1500": "1.5 segundos (Normal)", "2500": "2.5 segundos (Lento)" }
                }
            };
            
            let currentPlayingButton = null;
            let variantCyclerObserver;
            let showShareButton = localStorage.getItem('showShareButton') !== 'false';
            shareButtonToggle.checked = showShareButton;
            let showShopCountdownAlways = localStorage.getItem('showShopCountdownAlways') === 'true';
            shopCountdownToggle.checked = showShopCountdownAlways;
            let currentLanguage = localStorage.getItem('language') || 'en';
            languageSelect.value = currentLanguage;
            let autoCycleVariants = localStorage.getItem('autoCycleVariants') === 'true';
            variantCycleToggle.checked = autoCycleVariants;
            let newBadgeDuration = parseInt(localStorage.getItem('newBadgeDuration') || '7', 10);
            let variantCycleSpeed = parseInt(localStorage.getItem('variantCycleSpeed') || '1500', 10);
            let soundsEnabled = localStorage.getItem('soundsEnabled') !== 'false'; // Default to true
            soundsToggle.checked = soundsEnabled;

            // --- Sound Effect Setup ---
            const membraneSynth = new Tone.MembraneSynth({ volume: -10 }).toDestination();
            const playClickSound = () => { if (soundsEnabled && Tone.context.state === 'running') membraneSynth.triggerAttackRelease("C1", "8n", Tone.now()); };
            const playToggleSound = (isOn) => { if (soundsEnabled && Tone.context.state === 'running') membraneSynth.triggerAttackRelease(isOn ? "E1" : "C1", "8n", Tone.now()); };
            const playOpenSound = () => { if (soundsEnabled && Tone.context.state === 'running') membraneSynth.triggerAttackRelease("G1", "8n", Tone.now()); };
            const playCloseSound = () => { if (soundsEnabled && Tone.context.state === 'running') membraneSynth.triggerAttackRelease("A0", "8n", Tone.now()); };
            
            const startAudioContext = () => {
                if (Tone.context.state !== 'running') {
                    Tone.start();
                }
                document.body.removeEventListener('click', startAudioContext);
                document.body.removeEventListener('touchend', startAudioContext);
            };
            document.body.addEventListener('click', startAudioContext, { once: true });
            document.body.addEventListener('touchend', startAudioContext, { once: true });

            // --- Firebase Setup ---
            const firebaseConfig = {
                apiKey: "AIzaSyAddzy29C2Rbl9JVkHkvri42xMLHGnZg3Q",
                authDomain: "hollena.firebaseapp.com",
                projectId: "hollena",
                storageBucket: "hollena.firebasestorage.app",
                messagingSenderId: "594898644876",
                appId: "1:594898644876:web:ef321d30724a1cc038f0a9"
            };

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            let countryChart = null;
            let visitsTrendChart = null;
            let filterUsageChart = null;

            // --- Firebase Auth & User Logic ---

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    trackUserVisit(user); // Besuch für alle (auch anonyme) Nutzer tracken

                    if (user.isAnonymous) {
                        // UI für anonyme Benutzer handhaben
                        loggedOutIcon.classList.remove('hidden');
                        loggedInIcon.classList.add('hidden');
                        authDropdown.classList.add('hidden');
                    } else {
                        // Logik für registrierte Benutzer
                        const userDocRef = doc(db, "users", user.uid);
                        const userDoc = await getDoc(userDocRef);

                        if (!userDoc.exists()) {
                            console.error("Benutzer ist authentifiziert, hat aber kein Dokument:", user.uid);
                            await signOut(auth);
                            return;
                        }
                        
                        const userData = userDoc.data();

                        // Bann-Überprüfung
                        if (userData.status === 'banned') {
                            console.warn("Gesperrter Benutzer hat sich angemeldet. Automatischer Logout.");
                            showBannedMessage();
                            await signOut(auth);
                            return;
                        }

                        // Datenmigration für alte Benutzer, denen UID/Status fehlt
                        if (!userData.uid || !userData.status) {
                            console.log(`Aktualisiere fehlende Felder für Benutzer: ${user.uid}`);
                            await updateDoc(userDocRef, { 
                                uid: user.uid,
                                status: userData.status || 'active' // Fügt Status hinzu, falls er fehlt
                            });
                        }

                        // UI aktualisieren
                        loggedInIcon.classList.remove('hidden');
                        loggedOutIcon.classList.add('hidden');
                        userEmailDisplay.textContent = user.email; // E-Mail für ALLE registrierten Benutzer anzeigen

                        // Admin-Button basierend auf der Rolle ein-/ausblenden
                        if (userData.role === 'founder') {
                            adminPanelButton.classList.remove('hidden');
                            adminHr.classList.remove('hidden');
                        } else {
                            adminPanelButton.classList.add('hidden');
                            adminHr.classList.add('hidden');
                        }
                    }
                } else {
                    // Benutzer ist abgemeldet, anonym anmelden
                    signInAnonymously(auth).catch((error) => console.error("Anonymes Anmelden fehlgeschlagen:", error));
                }
            });

            function showBannedMessage() {
                // This is a simple implementation. A custom modal would be better.
                const bannedToast = document.createElement('div');
                bannedToast.textContent = 'Dein Account wurde gesperrt.';
                bannedToast.className = 'fixed top-8 left-1/2 -translate-x-1/2 bg-red-600 text-white px-6 py-3 rounded-xl shadow-lg z-50';
                document.body.appendChild(bannedToast);
                setTimeout(() => bannedToast.remove(), 4000);
            }

            async function trackUserVisit(user) {
                try {
                    const response = await fetch('https://ipapi.co/json/');
                    if (!response.ok) return; 
                    const data = await response.json();
                    
                    const visitData = {
                        uid: user.uid,
                        isAnonymous: user.isAnonymous,
                        country: data.country_name || 'Unknown',
                        countryCode: data.country_code || 'XX',
                        timestamp: new Date()
                    };

                    const visitDocRef = doc(collection(db, "visits"));
                    await setDoc(visitDocRef, visitData);
                } catch (error) {
                    console.error("Error tracking visit:", error);
                }
            }


            const rarityColorMap = {
                'legendary': '#e58800', 'epic': '#8c3eff', 'rare': '#0076c2', 'uncommon': '#0fa51d', 'common': '#7f7f7f', 'mythic': '#cda434',
                'exotic': '#00c8c8', 'icon': '#009c95', 'dark': '#c735b5', 'slurp': '#00a4b4', 'frozen': '#6593b4', 'lava': '#c13800',
                'shadow': '#414141', 'starwars': '#f8f800', 'marvel': '#9f0013', 'dc': '#003067', 'gaminglegends': '#4b0082',
            };

            const updateUIText = (lang) => {
                const t = translations[lang];
                document.documentElement.lang = lang;
                document.querySelectorAll('[data-translate]').forEach(el => {
                    const key = el.dataset.translate;
                    if (t[key] && typeof t[key] === 'string') el.textContent = t[key];
                });
                searchInput.placeholder = t.searchPlaceholder;
                toast.textContent = t.linkCopied;
                typeFilterContainer.innerHTML = '';
                Object.entries(t.typeOptions).forEach(([value, label]) => {
                    typeFilterContainer.innerHTML += `<label class="flex items-center gap-3 cursor-pointer"><input type="checkbox" value="${value}" class="fn-checkbox filter-checkbox"><span>${label}</span></label>`;
                });
                newBadgeDurationSelect.innerHTML = '';
                Object.entries(t.newBadgeOptions).forEach(([value, label]) => {
                    newBadgeDurationSelect.innerHTML += `<option value="${value}">${label}</option>`;
                });
                newBadgeDurationSelect.value = newBadgeDuration;
                variantCycleSpeedSelect.innerHTML = '';
                Object.entries(t.cycleSpeedOptions).forEach(([value, label]) => {
                    variantCycleSpeedSelect.innerHTML += `<option value="${value}">${label}</option>`;
                });
                variantCycleSpeedSelect.value = variantCycleSpeed;
            };
            
            const startShopCountdown = () => {
                if (countdownInterval) clearInterval(countdownInterval);
                const shouldShow = currentView === 'shop' || showShopCountdownAlways;
                if (!shouldShow) {
                    shopCountdownContainer.classList.add('hidden');
                    return;
                }
                shopCountdownContainer.classList.remove('hidden');
                countdownInterval = setInterval(() => {
                    const now = new Date();
                    const nextReset = new Date(now);
                    nextReset.setUTCHours(24, 0, 0, 0);
                    const diff = nextReset - now;
                    if (diff <= 1000) {
                        clearInterval(countdownInterval);
                        setTimeout(refreshShop, 1500);
                        return;
                    }
                    const hours = Math.floor(diff / 3600000);
                    const minutes = Math.floor((diff % 3600000) / 60000);
                    const seconds = Math.floor((diff % 60000) / 1000);
                    shopCountdown.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
            };

            const refreshShop = async () => {
                if (currentView === 'shop') shopLoaderOverlay.classList.remove('hidden');
                try {
                    const response = await fetch(`https://fortniteapi.io/v2/shop?lang=${currentLanguage}`, { headers: { 'Authorization': apiKey } });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const json = await response.json();
                    if (json.lastUpdate?.date && json.lastUpdate.date !== lastShopUpdate) {
                        shopData = null;
                        processShopData(json);
                        if (currentView === 'shop') {
                            itemGrid.innerHTML = '';
                            sidebarLinks.innerHTML = '';
                            applyFilters();
                        }
                    }
                } catch (error) {
                    console.error('Fehler beim Aktualisieren des Shops:', error);
                    if (currentView === 'shop') itemGrid.innerHTML = `<p class="col-span-full text-center text-xl text-red-500 py-16">Shop konnte nicht aktualisiert werden.</p>`;
                } finally {
                    if (currentView === 'shop') setTimeout(() => { shopLoaderOverlay.classList.add('hidden'); }, 500);
                    startShopCountdown();
                }
            };

            const updateShareButtonVisibility = () => document.body.classList.toggle('share-buttons-hidden', !showShareButton);

            const lazyImageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const lazyImage = entry.target;
                        const imageContainer = lazyImage.closest('.shimmer-bg');
                        lazyImage.onload = () => {
                            lazyImage.classList.remove('opacity-0');
                            if (imageContainer) {
                                imageContainer.classList.remove('shimmer-bg');
                                if (lazyImage.dataset.background) imageContainer.style.backgroundImage = `url('${lazyImage.dataset.background}')`;
                            }
                        };
                        lazyImage.src = lazyImage.dataset.src;
                        observer.unobserve(lazyImage);
                    }
                });
            });

            const isNew = (item) => {
                if (newBadgeDuration === 0 || !item.added) return false;
                const xDaysAgo = new Date();
                xDaysAgo.setDate(xDaysAgo.getDate() - newBadgeDuration);
                return new Date(item.added) >= xDaysAgo;
            };

            const renderCards = (items, existingCardCount = 0) => {
                const fragment = document.createDocumentFragment();
                items.forEach((item, index) => {
                    const imageUrl = item.images.featured || item.images.icon || item.images.smallIcon;
                    if (!imageUrl && !(item.variants?.flatMap(v => v.options?.map(o => o.image)).filter(Boolean).length > 0)) return;
                    const rarity = item.rarity?.value || 'common';
                    const rarityColor = rarityColorMap[rarity] || rarityColorMap['common'];
                    let priceHTML = '';
                    if (item.price > 0) priceHTML = `<div class="flex items-center font-semibold text-white mt-2"><svg viewBox="0 0 24 24" class="w-5 h-5 mr-1" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1.2 15.6c-.4.2-.8.3-1.2.3-.8 0-1.5-.3-2.1-.8-.6-.6-.9-1.3-.9-2.1 0-.8.3-1.5.8-2.1.5-.5 1.2-.8 2-.8.4 0 .8.1 1.2.2v1.9c-.3-.1-.6-.2-.9-.2-.4 0-.7.1-.9.4-.2.2-.4.5-.4.9s.1.7.4.9c.2.2.5.4.9.4.3 0 .6-.1.9-.2v1.8zM17 12.5c0 .8-.3 1.5-.8 2.1s-1.2.8-2 .8c-.4 0-.8-.1-1.2-.2v-1.9c.3.1.6.2.9.2.4 0 .7-.1.9-.4s.4-.5.4-.9-.1-.7-.4-.9c-.2-.2-.5-.4-.9-.4-.3 0-.6.1-.9.2V9.3c.4-.2.8-.3 1.2-.3.8 0 1.5.3 2.1.8.5.6.8 1.3.8 2.1z"/></svg><span>${item.price.toLocaleString('de-DE')}</span></div>`;
                    let musicPlayerButtonHTML = '';
                    if ((item.type?.value === 'music' || item.type?.value === 'jamtrack') && item.preview?.url) {
                        musicPlayerButtonHTML = `<button class="play-music-btn card-action bg-white/20 backdrop-blur-sm text-white w-10 h-10 rounded-full flex items-center justify-center text-lg hover:bg-white/40 transition-colors" data-audio-src="${item.preview.url}">▶</button>`;
                    }
                    const shareButtonHTML = `<button class="share-btn card-action bg-white/20 backdrop-blur-sm text-white w-8 h-8 rounded-full flex items-center justify-center text-sm hover:bg-white/40 transition-colors" data-item-id="${item.id}" title="Share"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.499 2.499 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12A2.5 2.5 0 0 1 11 2.5"/></svg></button>`;
                    const card = document.createElement('div');
                    card.className = `fn-card`;
                    card.style.setProperty('--rarity-color', rarityColor);
                    card.style.animationDelay = `${(existingCardCount + index) * 15}ms`;
                    card.dataset.itemId = item.id;
                    const variantImages = item.variants?.flatMap(v => v.options?.map(o => o.image)).filter(Boolean) || [];
                    const hasVariants = variantImages.length > 0;
                    let imageContent = '';
                    if (hasVariants) {
                        const allImages = [imageUrl, ...variantImages];
                        imageContent = `<div class="variant-image-container">${allImages.map((src, i) => `<img data-src="${src}" class="lazy variant-image ${i === 0 ? 'active' : ''}" alt="${item.name} Style ${i + 1}">`).join('')}</div>`;
                    } else {
                        imageContent = `<img data-src="${imageUrl}" data-background="${item.images.background || ''}" class="lazy w-full h-full object-contain opacity-0 transition-opacity duration-500" alt="${item.name}">`;
                    }
                    card.innerHTML = `<div class="fn-card-inner"><div class="relative aspect-square w-full bg-cover bg-center shimmer-bg">${isNew(item) ? `<div class="new-badge">${translations[currentLanguage].newBadge}</div>` : ''}${imageContent}</div><div class="relative p-4 text-left flex-grow flex flex-col justify-end"><div class="absolute top-4 right-4 flex flex-col items-center gap-2 z-10">${shareButtonHTML}${musicPlayerButtonHTML}</div><div><h3 class="text-lg font-semibold truncate pr-12">${item.name}</h3><p class="text-sm text-[var(--text-color-secondary)] capitalize">${item.type?.displayValue || ''}</p>${priceHTML}</div></div></div>`;
                    fragment.appendChild(card);
                    card.querySelectorAll('.lazy').forEach(img => lazyImageObserver.observe(img));
                    if (hasVariants) variantCyclerObserver.observe(card.querySelector('.variant-image-container'));
                });
                return fragment;
            };

            const renderShopSections = (sections) => {
                itemGrid.innerHTML = ''; sidebarLinks.innerHTML = ''; let totalItems = 0;
                sections.forEach((section) => {
                    if (!section.entries?.length) return;
                    const sectionId = section.id || `section-${Date.now()}`;
                    const sectionTitle = section.name || 'Empfohlen';
                    sidebarLinks.innerHTML += `<a href="#${sectionId}" data-section-id="${sectionId}" title="${sectionTitle}" class="sidebar-link w-full flex items-center px-2 py-1 rounded-lg"><div class="dot rounded-full"></div><span class="link-text whitespace-nowrap">${sectionTitle}</span></a>`;
                    const sectionWrapper = document.createElement('div');
                    sectionWrapper.id = sectionId;
                    sectionWrapper.innerHTML = `<h2 class="text-3xl font-bold mb-4 mt-8">${sectionTitle}</h2>`;
                    const items = section.entries.flatMap(entry => (entry.items || [entry]).map(item => ({ ...item, price: entry.finalPrice })));
                    totalItems += items.length;
                    const itemsGridForSection = document.createElement('div');
                    itemsGridForSection.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-5';
                    itemsGridForSection.appendChild(renderCards(items));
                    sectionWrapper.appendChild(itemsGridForSection);
                    itemGrid.appendChild(sectionWrapper);
                });
                itemCount.textContent = translations[currentLanguage].itemCountShop(totalItems);
            };

            const sectionObserver = new IntersectionObserver((entries) => {
                let mostVisibleEntry = null, maxRatio = 0;
                entries.forEach(entry => {
                    if (entry.isIntersecting && entry.intersectionRatio > maxRatio) {
                        maxRatio = entry.intersectionRatio; mostVisibleEntry = entry;
                    }
                });
                if (mostVisibleEntry) {
                    const id = mostVisibleEntry.target.getAttribute('id');
                    sidebarNav.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
                    const activeLink = sidebarNav.querySelector(`a[data-section-id="${id}"]`);
                    if (activeLink) activeLink.classList.add('active');
                }
            }, { threshold: [0.25, 0.5, 0.75] });
            
            const loadMoreItems = () => {
                if (currentView !== 'all' || currentlyDisplayedItems >= filteredAssets.length) return;
                const nextItems = filteredAssets.slice(currentlyDisplayedItems, currentlyDisplayedItems + 60);
                requestAnimationFrame(() => itemGrid.appendChild(renderCards(nextItems, currentlyDisplayedItems)));
                currentlyDisplayedItems += nextItems.length;
            };

            const infiniteScrollObserver = new IntersectionObserver((entries) => { if (entries[0].isIntersecting) loadMoreItems(); });
            infiniteScrollObserver.observe(sentinel);

            const logAnalytics = async (searchTerm, filterTypes) => {
                if (!searchTerm && filterTypes.length === 0) return;
                try {
                    const analyticsRef = doc(collection(db, "analytics"));
                    await setDoc(analyticsRef, {
                        type: 'search',
                        term: searchTerm || null,
                        filters: filterTypes,
                        timestamp: new Date(),
                        uid: auth.currentUser?.uid || 'anonymous'
                    });
                } catch (error) {
                    console.error("Error logging analytics:", error);
                }
            };

            const applyFilters = () => {
                const searchTerm = searchInput.value.toLowerCase().trim();
                const selectedTypes = lastAppliedFilterTypes;
                const showOnlyNew = lastAppliedShowOnlyNew;
                
                logAnalytics(searchTerm, selectedTypes);

                if (currentView === 'all') {
                    itemGrid.innerHTML = '';
                    itemGrid.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-5';
                    filteredAssets = allAssets.filter(item => (selectedTypes.length === 0 || selectedTypes.includes(item.type?.value)) && item.name.toLowerCase().includes(searchTerm) && (!showOnlyNew || isNew(item)));
                    currentlyDisplayedItems = 0; loadMoreItems();
                    itemCount.textContent = translations[currentLanguage].itemCount(filteredAssets.length);
                } else if (shopData) {
                    itemGrid.className = '';
                    const filteredSections = shopData.map(section => {
                        const filteredEntries = section.entries.map(entry => {
                            const filteredItems = (entry.items || [entry]).filter(item => (selectedTypes.length === 0 || selectedTypes.includes(item.type?.value)) && item.name.toLowerCase().includes(searchTerm) && (!showOnlyNew || isNew(item)));
                            return filteredItems.length > 0 ? { ...entry, items: filteredItems } : null;
                        }).filter(Boolean);
                        return filteredEntries.length > 0 ? { ...section, entries: filteredEntries } : null;
                    }).filter(Boolean);
                    renderShopSections(filteredSections);
                    document.querySelectorAll('[id^=section-]').forEach(sec => sectionObserver.observe(sec));
                }
            };
            
            searchInput.addEventListener('input', () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(applyFilters, 300); });
            
            const switchView = (view) => {
                playClickSound();
                currentView = view; searchInput.value = ''; lastAppliedFilterTypes = []; lastAppliedShowOnlyNew = false;
                document.querySelectorAll('.filter-checkbox').forEach(cb => { if (cb) cb.checked = false; });
                if (newItemsFilter) newItemsFilter.checked = false;
                itemGrid.innerHTML = ''; startShopCountdown();
                if (view === 'all') {
                    tabAll.classList.add('active'); tabShop.classList.remove('active');
                    sidebarNav.classList.add('hidden'); applyFilters();
                } else {
                    tabShop.classList.add('active'); tabAll.classList.remove('active');
                    itemGrid.className = ''; sidebarNav.classList.remove('hidden');
                    if (!shopData) {
                        loader.style.display = 'flex';
                        fetchShopData().then(applyFilters).catch(error => {
                           console.error('Error fetching shop data:', error);
                           itemGrid.innerHTML = `<p class="col-span-full text-center text-xl text-red-500 py-16">Shop-Daten konnten nicht geladen werden.</p>`;
                        }).finally(() => { loader.style.display = 'none'; });
                    } else { applyFilters(); }
                }
            };

            tabAll.addEventListener('click', () => switchView('all'));
            tabShop.addEventListener('click', () => switchView('shop'));

            const fetchAllAssets = async () => {
                try {
                    const response = await fetch(`https://fortnite-api.com/v2/cosmetics/br?language=${currentLanguage}`);
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const json = await response.json();
                    if (!json.data) throw new Error("Invalid API data.");
                    
                    const t = translations[currentLanguage];
                    allAssets = json.data.map(item => {
                        if (item && item.type && item.type.value === 'jam_track') { // API uses jam_track
                             return {
                                ...item,
                                type: { value: 'jamtrack', displayValue: t.typeOptions.jamtrack },
                            };
                        }
                        return item;
                    }).filter(item => item && item.name && (item.images?.featured || item.images?.icon));
                    
                    const urlParams = new URLSearchParams(window.location.search);
                    const itemIdToFind = urlParams.get('itemId');
                    if (itemIdToFind) {
                        const foundItem = allAssets.find(item => item.id === itemIdToFind);
                        if (foundItem) searchInput.value = foundItem.name;
                    }
                } catch (error) {
                    console.error('Error fetching all assets:', error);
                    itemGrid.innerHTML = `<p class="col-span-full text-center text-xl text-red-500 py-16">Daten konnten nicht geladen werden.</p>`;
                    allAssets = [];
                }
            };
            
            const fetchShopData = async () => {
                if (!apiKey) {
                    itemGrid.innerHTML = `<p class="col-span-full text-center text-xl text-yellow-400 py-16">Bitte gib einen API-Key ein, um den Shop anzuzeigen.</p>`;
                    throw new Error("API key is missing.");
                }
                try {
                    const response = await fetch(`https://fortniteapi.io/v2/shop?lang=${currentLanguage}`, { headers: { 'Authorization': apiKey } });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const json = await response.json();
                    if (!json.shop) throw new Error("Invalid shop API data.");
                    processShopData(json);
                } catch (error) { console.error('Error fetching shop data:', error); throw error; }
            };

            const processShopData = (json) => {
                lastShopUpdate = json.lastUpdate?.date;
                const sections = json.shop.reduce((acc, item) => {
                    const sectionName = item.section?.name || 'Other';
                    if (!acc[sectionName]) acc[sectionName] = { id: (item.section?.id || sectionName).replace(/[^a-zA-Z0-9]/g, '-').toLowerCase(), name: sectionName, entries: [] };
                    const fullAsset = allAssets.find(asset => asset.id === item.mainId || asset.id === item.id) || {
                        id: item.mainId || item.id, name: item.displayName, type: { value: item.type?.id, displayValue: item.type?.name },
                        rarity: { value: item.rarity?.id, displayValue: item.rarity?.name },
                        images: { featured: item.displayAssets?.[0]?.full_background || item.displayAssets?.[0]?.url, icon: item.displayAssets?.[0]?.url }
                    };
                    acc[sectionName].entries.push({ ...item, items: [fullAsset] });
                    return acc;
                }, {});
                shopData = Object.values(sections);
            };

            filterButton.addEventListener('click', () => { playOpenSound(); filterModal.classList.remove('hidden'); setTimeout(() => filterModal.classList.remove('opacity-0'), 10); });
            const closeModalHandler = () => {
                playCloseSound();
                document.querySelectorAll('.filter-checkbox').forEach(cb => { cb.checked = lastAppliedFilterTypes.includes(cb.value); });
                newItemsFilter.checked = lastAppliedShowOnlyNew;
                filterModal.classList.add('opacity-0'); setTimeout(() => filterModal.classList.add('hidden'), 300);
            };
            closeModalBtn.addEventListener('click', closeModalHandler);
            applyFiltersBtn.addEventListener('click', () => {
                playClickSound();
                lastAppliedFilterTypes = Array.from(document.querySelectorAll('.filter-checkbox:checked')).map(cb => cb.value);
                lastAppliedShowOnlyNew = newItemsFilter.checked;
                applyFilters(); 
                closeModalHandler();
            });

            sidebarLinks.addEventListener('click', (e) => {
                const link = e.target.closest('a.sidebar-link');
                if (link) {
                    playClickSound();
                    e.preventDefault();
                    const sectionId = link.getAttribute('href').substring(1);
                    const sectionElement = document.getElementById(sectionId);
                    if (sectionElement) {
                        const headerOffset = document.querySelector('.sticky')?.offsetHeight || 0;
                        const elementPosition = sectionElement.getBoundingClientRect().top;
                        window.scrollTo({ top: elementPosition + window.scrollY - headerOffset - 24, behavior: 'smooth' });
                    }
                }
            });

            itemGrid.addEventListener('click', (e) => {
                const card = e.target.closest('.fn-card');
                if (!card) return;
                const playButton = e.target.closest('.play-music-btn');
                const shareButton = e.target.closest('.share-btn');
                if (playButton) {
                    e.stopPropagation();
                    if (currentPlayingButton === playButton) {
                        audioPlayer.pause(); playButton.innerHTML = '▶'; currentPlayingButton = null;
                    } else {
                        if (currentPlayingButton) currentPlayingButton.innerHTML = '▶';
                        audioPlayer.src = playButton.dataset.audioSrc; audioPlayer.play();
                        playButton.innerHTML = '■'; currentPlayingButton = playButton;
                    }
                } else if (shareButton) {
                    e.stopPropagation();
                    playClickSound();
                    const shareUrl = `${window.location.origin}${window.location.pathname}?itemId=${card.dataset.itemId}`;
                    const tempInput = document.createElement('textarea');
                    tempInput.value = shareUrl; document.body.appendChild(tempInput);
                    tempInput.select(); document.execCommand('copy'); document.body.removeChild(tempInput);
                    toast.textContent = translations[currentLanguage].linkCopied;
                    toast.classList.remove('opacity-0', 'translate-y-4');
                    setTimeout(() => toast.classList.add('opacity-0', 'translate-y-4'), 2000);
                } else if (card.dataset.itemId) {
                    playOpenSound();
                    showItemDetails(card.dataset.itemId);
                }
            });

            profileButton.addEventListener('click', (e) => {
                e.stopPropagation();
                const user = auth.currentUser;
                if (user && !user.isAnonymous) {
                    playClickSound();
                    authDropdown.classList.toggle('hidden');
                } else {
                    openAuthModal();
                }
            });
            
            logoutButton.addEventListener('click', () => {
                playClickSound();
                signOut(auth);
                authDropdown.classList.add('hidden');
            });

            const openAuthModal = () => {
                playOpenSound();
                authModal.classList.remove('hidden');
                setTimeout(() => authModal.classList.remove('opacity-0'), 10);
                document.body.classList.add('no-scroll');
            };

            const closeAuthModalHandler = () => {
                playCloseSound();
                authModal.classList.add('opacity-0');
                setTimeout(() => {
                    authModal.classList.add('hidden');
                    loginError.textContent = '';
                    registerError.textContent = '';
                }, 300);
                 document.body.classList.remove('no-scroll');
            };
            
            closeAuthModalBtn.addEventListener('click', closeAuthModalHandler);

            showRegisterViewBtn.addEventListener('click', () => {
                playClickSound();
                loginView.classList.add('hidden');
                registerView.classList.remove('hidden');
            });

            showLoginViewBtn.addEventListener('click', () => {
                playClickSound();
                registerView.classList.add('hidden');
                loginView.classList.remove('hidden');
            });

            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                playClickSound();
                const email = loginForm['login-email'].value;
                const password = loginForm['login-password'].value;
                signInWithEmailAndPassword(auth, email, password)
                    .then(() => closeAuthModalHandler())
                    .catch(error => { loginError.textContent = error.message; });
            });

            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                playClickSound();
                const email = registerForm['register-email'].value;
                const password = registerForm['register-password'].value;
                 registerError.textContent = '';

                try {
                    // ROBUSTERE ÜBERPRÜFUNG: Prüft direkt in der Benutzer-Collection, ob bereits ein Founder existiert.
                    const usersRef = collection(db, "users");
                    const q = query(usersRef, where("role", "==", "founder"), limit(1));
                    const founderSnapshot = await getDocs(q);
                    const isFirstUser = founderSnapshot.empty;

                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    
                    const userRole = isFirstUser ? 'founder' : 'user';

                    await setDoc(doc(db, "users", user.uid), {
                        uid: user.uid,
                        email: user.email,
                        createdAt: new Date(),
                        role: userRole,
                        status: 'active'
                    });

                    if (isFirstUser) {
                        // Die founderUID wird weiterhin in metadata gespeichert, damit die Sicherheitsregeln funktionieren.
                        const metadataRef = doc(db, "metadata", "admin");
                        await setDoc(metadataRef, { founderUID: user.uid }, { merge: true });
                    }

                    closeAuthModalHandler();
                } catch (error) {
                    registerError.textContent = error.message;
                }
            });


            const showItemDetails = async (itemId) => {
                const item = allAssets.find(i => i.id === itemId);
                if (!item) return;
                detailImage.src = ''; detailImage.classList.add('opacity-0'); detailImageContainer.classList.add('shimmer-bg');
                itemDetailModal.classList.remove('hidden'); setTimeout(() => itemDetailModal.classList.remove('opacity-0'), 10);
                document.body.classList.add('no-scroll');
                detailName.textContent = item.name;
                detailRarity.textContent = item.rarity?.displayValue || '';
                detailRarity.style.color = rarityColorMap[item.rarity?.value] || '#fff';
                detailDescription.textContent = item.description || '';
                detailImage.src = item.images.featured || item.images.icon;
                detailImage.onload = () => { detailImage.classList.remove('opacity-0'); detailImageContainer.classList.remove('shimmer-bg'); };
                detailStats.innerHTML = `<div class="flex justify-center items-center h-24"><div class="loader !w-8 !h-8"></div></div>`;
                try {
                    const response = await fetch(`https://fortnite-api.com/v2/cosmetics/br/search/ids?id=${itemId}&language=${currentLanguage}`);
                    if (!response.ok) throw new Error('Stats not found');
                    const statsData = await response.json();
                    const history = statsData.data?.[0]?.shopHistory;
                    const t = translations[currentLanguage];
                    if (history?.length > 0) {
                        detailStats.innerHTML = `
                            <div class="flex justify-between items-center text-base"><span class="text-[var(--text-color-secondary)]">${t.statsLastSeen}</span><span class="font-semibold">${new Date(history[history.length - 1]).toLocaleDateString(currentLanguage, { day: '2-digit', month: '2-digit', year: 'numeric' })}</span></div>
                            <div class="flex justify-between items-center text-base"><span class="text-[var(--text-color-secondary)]">${t.statsOccurrences}</span><span class="font-semibold">${history.length}</span></div>
                            <div class="flex justify-between items-center text-base"><span class="text-[var(--text-color-secondary)]">${t.statsFirstSeen}</span><span class="font-semibold">${new Date(history[0]).toLocaleDateString(currentLanguage, { day: '2-digit', month: '2-digit', year: 'numeric' })}</span></div>`;
                    } else { detailStats.innerHTML = `<p class="text-center text-[var(--text-color-secondary)]">${t.statsNotAvailable}</p>`; }
                } catch (error) {
                    console.error("Error loading item stats:", error);
                    detailStats.innerHTML = `<p class="text-center text-[var(--text-color-secondary)]">${translations[currentLanguage].statsNotAvailable}</p>`;
                }
            };
            
            const closeDetailModalHandler = () => {
                playCloseSound();
                itemDetailModal.classList.add('opacity-0');
                setTimeout(() => {
                    itemDetailModal.classList.add('hidden'); detailImage.src = "";
                    detailImage.classList.add('opacity-0'); detailImageContainer.classList.add('shimmer-bg');
                }, 300);
                document.body.classList.remove('no-scroll');
            };
            closeDetailModal.addEventListener('click', closeDetailModalHandler);
            itemDetailModal.addEventListener('click', (e) => { if (e.target === itemDetailModal) closeDetailModalHandler(); });
            audioPlayer.addEventListener('ended', () => { if (currentPlayingButton) { currentPlayingButton.innerHTML = '▶'; currentPlayingButton = null; } });
            window.addEventListener('scroll', () => scrollToTopBtn.classList.toggle('show', window.scrollY > 400));
            scrollToTopBtn.addEventListener('click', () => { playClickSound(); window.scrollTo({ top: 0, behavior: 'smooth' }); });

            const handleVariantCyclingUpdate = () => {
                document.querySelectorAll('.variant-image-container').forEach(container => {
                    let intervalId = parseInt(container.dataset.intervalId, 10);
                    if (intervalId) { clearInterval(intervalId); container.dataset.intervalId = ''; }
                    if (!autoCycleVariants) {
                        const images = container.querySelectorAll('.variant-image');
                        if (images.length > 0) { images.forEach(img => img.classList.remove('active')); images[0].classList.add('active'); }
                    }
                    variantCyclerObserver.unobserve(container); variantCyclerObserver.observe(container);
                });
            };

            settingsButton.addEventListener('click', (e) => { e.stopPropagation(); settingsMenu.classList.toggle('hidden'); playOpenSound(); });
            variantCycleToggle.addEventListener('change', () => {
                autoCycleVariants = variantCycleToggle.checked;
                localStorage.setItem('autoCycleVariants', autoCycleVariants);
                playToggleSound(autoCycleVariants);
                handleVariantCyclingUpdate();
            });
            document.addEventListener('click', (e) => {
                if (!settingsMenu.classList.contains('hidden') && !settingsMenu.contains(e.target) && e.target !== settingsButton) {
                    settingsMenu.classList.add('hidden');
                    playCloseSound();
                }
                if(!authDropdown.classList.contains('hidden') && !authDropdown.contains(e.target) && e.target !== profileButton){
                    authDropdown.classList.add('hidden');
                }
            });

            const applyAccentColor = (color) => {
                document.documentElement.style.setProperty('--accent-color', color);
                document.querySelectorAll('.color-swatch').forEach(swatch => swatch.classList.toggle('selected', swatch.dataset.color === color));
            };
            const savedColor = localStorage.getItem('accentColor') || '#007aff';
            applyAccentColor(savedColor);
            colorPicker.addEventListener('click', (e) => {
                const swatch = e.target.closest('.color-swatch');
                if (swatch) {
                    playClickSound();
                    const newColor = swatch.dataset.color;
                    localStorage.setItem('accentColor', newColor);
                    applyAccentColor(newColor);
                }
            });

            newBadgeDurationSelect.addEventListener('change', () => {
                newBadgeDuration = parseInt(newBadgeDurationSelect.value, 10);
                localStorage.setItem('newBadgeDuration', newBadgeDuration);
                applyFilters();
            });
            variantCycleSpeedSelect.addEventListener('change', () => {
                variantCycleSpeed = parseInt(variantCycleSpeedSelect.value, 10);
                localStorage.setItem('variantCycleSpeed', variantCycleSpeed);
                handleVariantCyclingUpdate();
            });

            languageSelect.addEventListener('change', async () => {
                currentLanguage = languageSelect.value;
                localStorage.setItem('language', currentLanguage);
                updateUIText(currentLanguage);
                document.querySelectorAll('.custom-select-container').forEach(c => c.remove());
                setupCustomSelects();
                loader.style.display = 'flex';
                itemGrid.innerHTML = '';
                sidebarLinks.innerHTML = '';
                shopData = null; 
                await fetchAllAssets();
                if (currentView === 'shop') await fetchShopData();
                applyFilters();
                loader.style.display = 'none';
            });
            
            shareButtonToggle.addEventListener('change', () => {
                showShareButton = shareButtonToggle.checked;
                playToggleSound(showShareButton);
                localStorage.setItem('showShareButton', showShareButton);
                updateShareButtonVisibility();
            });
            shopCountdownToggle.addEventListener('change', () => {
                showShopCountdownAlways = shopCountdownToggle.checked;
                playToggleSound(showShopCountdownAlways);
                localStorage.setItem('showShopCountdownAlways', showShopCountdownAlways);
                startShopCountdown();
            });
            soundsToggle.addEventListener('change', () => {
                soundsEnabled = soundsToggle.checked;
                localStorage.setItem('soundsEnabled', soundsEnabled);
                playToggleSound(soundsEnabled);
            });


            variantCyclerObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const container = entry.target;
                    let intervalId = parseInt(container.dataset.intervalId, 10);
                    if (entry.isIntersecting) {
                        if (autoCycleVariants && !intervalId && container.querySelectorAll('.variant-image').length > 1) {
                            let currentIndex = 0;
                            intervalId = setInterval(() => {
                                const images = container.querySelectorAll('.variant-image');
                                images[currentIndex].classList.remove('active');
                                currentIndex = (currentIndex + 1) % images.length;
                                images[currentIndex].classList.add('active');
                                container.classList.add('shine-active');
                                setTimeout(() => container.classList.remove('shine-active'), 600);
                            }, variantCycleSpeed);
                            container.dataset.intervalId = intervalId;
                        }
                    } else if (intervalId) { clearInterval(intervalId); container.dataset.intervalId = ''; }
                });
            });
            
            // --- Admin Panel Logic ---

            adminTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    playClickSound();
                    adminTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    const tabName = tab.dataset.tab;
                    adminTabContents.forEach(content => {
                        content.classList.toggle('hidden', content.id !== `admin-${tabName}-tab`);
                    });
                });
            });

            adminPanelButton.addEventListener('click', () => {
                playOpenSound();
                authDropdown.classList.add('hidden');
                adminPanelModal.classList.remove('hidden');
                setTimeout(() => adminPanelModal.classList.remove('opacity-0'), 10);
                document.body.classList.add('no-scroll');
                loadAdminStats();
            });
            
            closeAdminModal.addEventListener('click', () => {
                 playCloseSound();
                 adminPanelModal.classList.add('opacity-0');
                 setTimeout(() => adminPanelModal.classList.add('hidden'), 300);
                 document.body.classList.remove('no-scroll');
                 if (visitsListener) visitsListener();
                 if (usersListener) usersListener();
                 if (analyticsListener) analyticsListener();
            });

            async function loadAdminStats() {
                if (countryChart) countryChart.destroy();
                if(visitsTrendChart) visitsTrendChart.destroy();
                if(filterUsageChart) filterUsageChart.destroy();
                
                const announcementDoc = await getDoc(doc(db, "globals", "announcement"));
                if(announcementDoc.exists()) announcementInput.value = announcementDoc.data().text || '';
                
                // Holt die UID des Founders einmalig
                const metadataRef = doc(db, "metadata", "admin");
                const metadataSnap = await getDoc(metadataRef);
                const founderUID = metadataSnap.exists() ? metadataSnap.data().founderUID : null;

                visitsListener = onSnapshot(query(collection(db, "visits"), orderBy("timestamp", "desc")), (snapshot) => {
                    const visits = snapshot.docs.map(d => d.data());
                    const countryData = visits.reduce((acc, v) => { acc[v.country || 'Unknown'] = (acc[v.country || 'Unknown'] || 0) + 1; return acc; }, {});
                    const sortedCountries = Object.entries(countryData).sort(([, a], [, b]) => b - a).slice(0, 5);
                    if(countryChart) countryChart.destroy();
                    countryChart = new Chart(countryChartCanvas, { type: 'doughnut', data: { labels: sortedCountries.map(e => e[0]), datasets: [{ data: sortedCountries.map(e => e[1]), backgroundColor: ['#007aff', '#ff9500', '#34c759', '#af52de', '#5856d6'], borderColor: 'transparent' }] }, options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { color: 'white' } } } } });

                    const visitsByDay = visits.reduce((acc, visit) => { const day = visit.timestamp.toDate().toISOString().split('T')[0]; acc[day] = (acc[day] || 0) + 1; return acc; }, {});
                    const trendLabels = Array.from({length: 7}, (_, i) => { const d = new Date(); d.setDate(d.getDate() - i); return d.toISOString().split('T')[0]; }).reverse();
                    const trendData = trendLabels.map(day => visitsByDay[day] || 0);
                    if(visitsTrendChart) visitsTrendChart.destroy();
                    visitsTrendChart = new Chart(visitsTrendChartCanvas, { type: 'line', data: { labels: trendLabels, datasets: [{ label: 'Besucher', data: trendData, borderColor: 'var(--accent-color)', tension: 0.3, fill: false }] }, options: { scales: { x: { type: 'time', time: { unit: 'day' }, ticks: { color: 'white'} }, y: { ticks: { color: 'white', stepSize: 1, beginAtZero: true } } }, plugins: { legend: { labels: { color: 'white' } } } } });
                });

                usersListener = onSnapshot(query(collection(db, "users")), (snapshot) => {
                    const users = snapshot.docs.map(d => d.data());
                    userListContainer.innerHTML = `<table class="w-full text-sm text-left">
                        <thead class="text-xs text-gray-400 uppercase"><tr><th class="p-2">Benutzer</th><th class="p-2">Rolle</th><th class="p-2">Status</th><th class="p-2 text-right">Aktionen</th></tr></thead>
                        <tbody>${users.map(u => {
                            const isFounder = u.uid === founderUID;
                            
                            return `<tr class="border-b border-white/10 ${u.status === 'banned' ? 'opacity-50' : ''}">
                                <td class="p-2">
                                    <div class="font-medium truncate cursor-pointer hover:underline user-detail-btn" data-uid="${u.uid}">${u.email}</div>
                                    <div class="text-xs text-gray-500 font-mono truncate" title="${u.uid || 'Keine ID'}">${u.uid || 'Keine ID'}</div>
                                </td>
                                <td class="p-2 capitalize">${u.role}</td>
                                <td class="p-2"><span class="px-2 py-1 text-xs rounded-full ${u.status === 'banned' ? 'bg-red-500/50 text-red-200' : 'bg-green-500/50 text-green-200'}">${u.status}</span></td>
                                <td class="p-2 text-right space-x-2">
                                    <button class="fn-button !text-xs !px-2 !py-1 rounded-md toggle-role-btn" data-uid="${u.uid}" data-role="${u.role}" ${isFounder ? 'disabled' : ''}>
                                        ${isFounder ? 'Herabstufen' : (u.role === 'user' ? 'Zum Moderator' : 'Zum Benutzer')}
                                    </button>
                                    <button class="fn-button !text-xs !px-2 !py-1 rounded-md toggle-ban-btn ${u.status === 'banned' ? '!bg-green-500' : '!bg-red-500'}" data-uid="${u.uid}" data-status="${u.status}" ${isFounder ? 'disabled' : ''}>${u.status === 'banned' ? 'Entsperren' : 'Sperren'}</button>
                                </td>
                            </tr>`;
                        }).join('')}</tbody>
                    </table>`;
                });

                analyticsListener = onSnapshot(query(collection(db, "analytics"), orderBy("timestamp", "desc"), limit(1000)), (snapshot) => {
                    const analytics = snapshot.docs.map(d => d.data());
                    const searchCounts = analytics.filter(a => a.term).reduce((acc, a) => { const term = a.term.toLowerCase(); acc[term] = (acc[term] || 0) + 1; return acc; }, {});
                    const topSearches = Object.entries(searchCounts).sort(([,a],[,b]) => b-a).slice(0, 10);
                    topSearchesContainer.innerHTML = topSearches.map(([term, count]) => `<div class="p-2 rounded-lg bg-white/5 flex justify-between"><span>${term}</span> <b>${count}x</b></div>`).join('');

                    const filterCounts = analytics.flatMap(a => a.filters).reduce((acc, f) => { acc[f] = (acc[f] || 0) + 1; return acc; }, {});
                    const topFilters = Object.entries(filterCounts).sort(([,a],[,b]) => b-a);
                    const t = translations[currentLanguage].typeOptions;
                    const accentColorRGB = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').match(/\d+/g).join(',');
                    if(filterUsageChart) filterUsageChart.destroy();
                    filterUsageChart = new Chart(filterUsageChartCanvas, { type: 'bar', data: { labels: topFilters.map(([key]) => t[key] || key), datasets: [{ label: 'Nutzung', data: topFilters.map(([,val]) => val), backgroundColor: `rgba(${accentColorRGB}, 0.5)` }] }, options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: 'white', stepSize: 1 } }, y: { ticks: { color: 'white' } } } } });
                });
            }

            userListContainer.addEventListener('click', async e => {
                const roleBtn = e.target.closest('.toggle-role-btn');
                const banBtn = e.target.closest('.toggle-ban-btn');
                const detailBtn = e.target.closest('.user-detail-btn');

                if (roleBtn) {
                    const uid = roleBtn.dataset.uid;
                    if (!uid || roleBtn.disabled) return;
                    const newRole = roleBtn.dataset.role === 'user' ? 'moderator' : 'user';
                    await updateDoc(doc(db, "users", uid), { role: newRole });
                } else if (banBtn) {
                    const uid = banBtn.dataset.uid;
                    if (!uid || banBtn.disabled) return;
                    const newStatus = banBtn.dataset.status === 'banned' ? 'active' : 'banned';
                    await updateDoc(doc(db, "users", uid), { status: newStatus });
                } else if (detailBtn) {
                    const uid = detailBtn.dataset.uid;
                    if (!uid) return;
                    showUserDetails(uid);
                }
            });

            async function showUserDetails(uid) {
                playOpenSound();
                const userDoc = await getDoc(doc(db, "users", uid));
                if (!userDoc.exists()) return;
                const userData = userDoc.data();
                
                const visitsQuery = query(collection(db, "visits"), where("uid", "==", uid), orderBy("timestamp", "desc"), limit(5));
                const visitsSnap = await getDocs(visitsQuery);
                const visitsHTML = visitsSnap.docs.map(d => `<li>${d.data().timestamp.toDate().toLocaleString()} - ${d.data().country}</li>`).join('');

                userDetailContent.innerHTML = `
                    <p><strong>E-Mail:</strong> ${userData.email}</p>
                    <p><strong>User ID:</strong> <span class="text-xs">${userData.uid}</span></p>
                    <p><strong>Rolle:</strong> ${userData.role}</p>
                    <p><strong>Status:</strong> ${userData.status}</p>
                    <p><strong>Registriert seit:</strong> ${userData.createdAt.toDate().toLocaleString()}</p>
                    <hr class="border-white/10 my-2">
                    <p><strong>Letzte 5 Besuche:</strong></p>
                    <ul class="list-disc list-inside text-sm text-gray-300">${visitsHTML || 'Keine Besuche aufgezeichnet.'}</ul>
                `;
                userDetailModal.classList.remove('hidden');
                setTimeout(() => userDetailModal.classList.remove('opacity-0'), 10);
            }

            closeUserDetailModal.addEventListener('click', () => {
                playCloseSound();
                userDetailModal.classList.add('opacity-0');
                setTimeout(() => userDetailModal.classList.add('hidden'), 300);
            });
            
            saveAnnouncementBtn.addEventListener('click', async () => {
                const text = announcementInput.value.trim();
                saveAnnouncementBtn.disabled = true;
                try {
                    await setDoc(doc(db, "globals", "announcement"), { text: text, updatedAt: new Date() });
                    toast.textContent = translations[currentLanguage].announcementSaved;
                    toast.classList.remove('opacity-0', 'translate-y-4');
                    setTimeout(() => toast.classList.add('opacity-0', 'translate-y-4'), 2000);
                } catch(e) { console.error("Fehler beim Speichern der Ankündigung: ", e); } 
                finally { saveAnnouncementBtn.disabled = false; }
            });

            closeAnnouncementBtn.addEventListener('click', () => {
                announcementBanner.classList.add('hidden');
            });
            
            onSnapshot(doc(db, "globals", "announcement"), (doc) => {
                if(doc.exists() && doc.data().text) {
                    announcementText.textContent = doc.data().text;
                    announcementBanner.classList.remove('hidden');
                } else {
                    announcementBanner.classList.add('hidden');
                }
            });

            function setupCustomSelects() {
                document.querySelectorAll('select').forEach(selectElement => {
                    if (selectElement.nextElementSibling?.classList.contains('custom-select-container')) {
                        selectElement.nextElementSibling.remove();
                    }
                    const container = document.createElement('div');
                    container.className = 'custom-select-container ios-input';
                    selectElement.parentNode.insertBefore(container, selectElement.nextSibling);
                    const trigger = document.createElement('div');
                    trigger.className = 'custom-select-trigger';
                    trigger.textContent = selectElement.options[selectElement.selectedIndex].textContent;
                    container.appendChild(trigger);
                    const optionsWrapper = document.createElement('div');
                    optionsWrapper.className = 'custom-select-options glass-effect';
                    container.appendChild(optionsWrapper);
                    Array.from(selectElement.options).forEach(option => {
                        const optionEl = document.createElement('div');
                        optionEl.className = 'custom-select-option';
                        optionEl.textContent = option.textContent;
                        optionEl.dataset.value = option.value;
                        if(option.selected) optionEl.classList.add('selected');
                        optionsWrapper.appendChild(optionEl);
                        optionEl.addEventListener('click', () => {
                            playClickSound();
                            trigger.textContent = option.textContent;
                            selectElement.value = option.value;
                            selectElement.dispatchEvent(new Event('change'));
                            optionsWrapper.classList.remove('open');
                            container.querySelectorAll('.custom-select-option').forEach(opt => opt.classList.remove('selected'));
                            optionEl.classList.add('selected');
                        });
                    });
                    trigger.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const wasOpen = optionsWrapper.classList.contains('open');
                        closeAllSelects(null);
                        if(!wasOpen) {
                            playOpenSound();
                            optionsWrapper.classList.add('open');
                        }
                    });
                });
            }

            function closeAllSelects(except) {
                 document.querySelectorAll('.custom-select-options.open').forEach(openSelect => {
                    if (openSelect.parentNode !== except) {
                        openSelect.classList.remove('open');
                    }
                });
            }
            
            document.addEventListener('click', () => closeAllSelects(null));

            const initialLoad = async () => {
                updateUIText(currentLanguage);
                setupCustomSelects();
                updateShareButtonVisibility();
                startShopCountdown();
                loader.style.display = 'flex';
                await fetchAllAssets();
                applyFilters();
                loader.style.display = 'none';
            };

            initialLoad();
        });
    </script>
</body>
</html>




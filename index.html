<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sims 4 Mod Checker — Dark UI</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0d1117;color:#e6edf3;display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px;}
    .container{background:#161b22;padding:28px;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.6);max-width:980px;width:100%;box-sizing:border-box;display:flex;flex-direction:column;gap:20px;}
    h1{margin:0 0 4px;color:#2ecc71}
    p{margin:0 0 10px;color:#9aa5b1}
    .top{display:flex;gap:12px;align-items:center}
    #plumbobCanvas{width:64px;height:96px;display:block;}
    .dropzone{border:2px dashed #30363d;border-radius:12px;padding:14px;color:#8b949e;cursor:pointer;text-align:left; transition: border-color 0.3s ease;}
    .dropzone:hover { border-color: #2ecc71; }
    .row{display:flex;gap:10px;flex-wrap:wrap;}
    button{
      position: relative;
      overflow: hidden;
      padding:10px 14px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      font-weight:700;
      background:#2ecc71;
      color:#041014;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    button.secondary{ background:#2b6fda;color:#fff; }
    button.danger{ background:#7f8c8d;color:#fff; }
    button::before {
      content: '';
      position: absolute;
      top: -100%;
      left: -100%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.4) 0%, rgba(255, 255, 255, 0) 70%);
      transition: transform 0.4s ease;
      opacity: 0;
    }
    button:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    button:hover::before {
      transform: translate(25%, 25%);
      opacity: 1;
    }
    .filters-row{display:flex;flex-wrap:wrap;gap:20px;align-items:center;}
    .filter-group{display:flex;gap:10px;flex-wrap:wrap;}
    .search-input{flex:1;min-width:150px;padding:8px;border-radius:8px;background:#0b1220;border:1px solid #29323a;color:#e6edf3;}
    #progress{width:100%;height:12px;border-radius:8px;border:1px solid #1e262a;box-shadow:inset 0 1px 3px rgba(0,0,0,0.5);-webkit-appearance:none;appearance:none;background:#0d1117;overflow:hidden;}
    #progress::-webkit-progress-bar{background:transparent;}
    #progress::-webkit-progress-value{background:#2ecc71;}
    #progress::-moz-progress-bar{background:#2ecc71;}
    #progress.animated-progress::-webkit-progress-value{
        background-color: #2ecc71;
        background-image: linear-gradient(90deg, #2ecc71 0%, #2ecc71 20%, rgba(255, 255, 255, 0.5) 50%, #2ecc71 80%, #2ecc71 100%);
        background-size: 200% 100%;
        animation: animate-shine 1.5s linear infinite;
    }
    #progress.animated-progress::-moz-progress-bar{
        background-color: #2ecc71;
        background-image: linear-gradient(90deg, #2ecc71 0%, #2ecc71 20%, rgba(255, 255, 255, 0.5) 50%, #2ecc71 80%, #2ecc71 100%);
        background-size: 200% 100%;
        animation: animate-shine 1.5s linear infinite;
    }
    @keyframes animate-shine{
        from{background-position:100% 0;}
        to{background-position:-100% 0;}
    }
    #log{background:#0b0f13;border:1px solid #22272b;border-radius:10px;padding:12px;color:#c1ccd6;max-height:320px;overflow:auto;}
    .line{padding:8px;border-radius:8px;margin-bottom:6px;display:flex;justify-content:space-between;gap:8px;}
    .left{flex:1;word-break:break-word;display:flex;flex-direction:column;}
    .meta{font-size:12px;color:#93a3af;}
    .ok{background:linear-gradient(90deg, rgba(46,204,113,0.06), transparent);color:#2ecc71}
    .cc{background:linear-gradient(90deg, rgba(26,188,156,0.06), transparent);color:#1abc9c}
    .script{background:linear-gradient(90deg, rgba(59,130,246,0.04), transparent);color:#5dade2}
    .zip{background:linear-gradient(90deg, rgba(155,89,182,0.04), transparent);color:#af7ac5}
    .broken{background:linear-gradient(90deg, rgba(231,76,60,0.04), transparent);color:#e74c3c;animation:blink 1s step-start infinite;}
    .skipped{background:linear-gradient(90deg, rgba(149, 165, 166, 0.04), transparent);color:#95a5a6;}
    .copy-btn {
        background: none;
        border: 1px solid #95a5a6;
        color: #95a5a6;
        padding: 4px 8px;
        font-size: 12px;
        font-weight: bold;
        cursor: pointer;
        border-radius: 6px;
        transition: background-color 0.2s, color 0.2s;
        margin-left: 8px;
    }
    .copy-btn:hover {
        background: #95a5a6;
        color: #0d1117;
    }
    @keyframes blink{50%{opacity:0.6}}
    .stats{display:flex;gap:8px;flex-wrap:wrap;}
    .stat{background:#0b1216;padding:8px 10px;border-radius:8px;border:1px solid #1e262a;color:#bfcbd6;}
    table{width:100%;border-collapse:collapse;}
    th,td{padding:6px 8px;border-bottom:1px solid #1b2327;font-size:13px;color:#c7d6df;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,monospace;}
    select {
        padding: 8px;
        border-radius: 8px;
        background: #0b1220;
        border: 1px solid #29323a;
        color: #e6edf3;
    }
    #message-box {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #22272b;
        color: #e6edf3;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        z-index: 1000;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="top">
      <canvas id="plumbobCanvas"></canvas>
      <div>
        <h1>Sims 4 Mod Checker</h1>
        <p>Multi-Threaded Scan (Web Workers) — schnellere Verarbeitung großer Mods-Sammlungen</p>
      </div>
    </div>

    <label class="dropzone" for="fileInput">Zieh deinen Mods-Ordner hierher (inkl. Unterordner) oder klicke, um auszuwählen</label>
    <input id="fileInput" type="file" webkitdirectory directory multiple style="display:none" />

    <div class="row">
      <button id="scanBtn" class="primary">1. Mods Scannen</button>
      <button id="zipBtn" class="secondary" disabled>2. Ausgewählte Typen als ZIP packen</button>
      <button id="zipBrokenBtn" class="danger" disabled>3. BROKEN als ZIP packen</button>
      <button id="resetBtn" class="secondary">Zurücksetzen</button>
    </div>
    
    <div class="filters-row">
      <input id="search" class="search-input" placeholder="Live-Suche" />
      <select id="statusFilter">
          <option value="all">Alle anzeigen</option>
          <option value="ok">OK</option>
          <option value="broken">BROKEN</option>
          <option value="skipped">SKIPPED</option>
      </select>
    </div>

    <div class="filters">
      <label><input type="checkbox" id="filterCC" checked> CC (.package)</label>
      <label><input type="checkbox" id="filterScript" checked> Scripts (.ts4script)</label>
      <label><input type="checkbox" id="filterZip" checked> ZIP-Dateien</label>
      <div style="margin-left:auto;color:#95a5a6">Workers: <span id="workerCount"></span></div>
    </div>

    <progress id="progress" value="0" max="100" style="display:none"></progress>

    <div class="stats" id="stats">
      <div class="stat">Gescannt:<div class="mono" id="statScanned">0</div></div>
      <div class="stat">OK:<div class="mono" id="statOK">0</div></div>
      <div class="stat">BROKEN:<div class="mono" id="statBroken">0</div></div>
      <div class="stat">SKIPPED:<div class="mono" id="statSkipped">0</div></div>
      <div class="stat">Duplikate:<div class="mono" id="statDup">0</div></div>
      <div class="stat">Dauer:<div class="mono" id="statTime">0s</div></div>
    </div>

    <div id="log">Das Protokoll wird hier angezeigt...</div>

    <h3 style="color:#bfe1c9;">Top 10 größte Mods</h3>
    <table id="topTable"><thead><tr><tr><th>Pfad</th><th class="mono">Größe</th><th class="mono">SHA-1</th></tr></thead><tbody></tbody></table>

    <div id="message-box"></div>

  </div>

  <script>
  try {
    // --- 3D Plumbob Setup ---
    window.onload = function() {
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, 64 / 96, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('plumbobCanvas'), alpha: true, antialias: true });
        renderer.setClearColor(0x000000, 0);

        const coneGeometry = new THREE.ConeGeometry(0.7, 1.5, 6);
        const material = new THREE.MeshStandardMaterial({
            color: 0x2ecc71,
            roughness: 0.1,
            metalness: 0,
        });
        
        const topCone = new THREE.Mesh(coneGeometry, material);
        const bottomCone = new THREE.Mesh(coneGeometry, material);

        topCone.position.y = 0.75;
        bottomCone.rotation.x = Math.PI;
        bottomCone.position.y = -0.75;
        
        const plumbob = new THREE.Group();
        plumbob.add(topCone);
        plumbob.add(bottomCone);
        plumbob.position.z = -12;
        plumbob.scale.set(2.5, 2.5, 2.5);
        
        scene.add(plumbob);

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.2); 
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(2, 5, 3);
        scene.add(directionalLight);
        const pointLight1 = new THREE.PointLight(0xffffff, 0.5);
        pointLight1.position.set(-5, 5, 5);
        scene.add(pointLight1);
        const pointLight2 = new THREE.PointLight(0xffffff, 0.5);
        pointLight2.position.set(5, -5, -5);
        scene.add(pointLight2);

        function animate() {
            requestAnimationFrame(animate);
            plumbob.rotation.y += 0.01;
            renderer.render(scene, camera);
        }
        animate();
    };

    // --- Konfiguration ---
    const SUPPORTED = ['.package', '.ts4script', '.zip'];
    const MAX_FILES = 4000;
    const WORKER_COUNT = Math.max(1, (navigator.hardwareConcurrency || 4) - 1);

    // --- UI Referenzen ---
    const fileInput = document.getElementById('fileInput');
    const scanBtn = document.getElementById('scanBtn');
    const zipBtn = document.getElementById('zipBtn');
    const zipBrokenBtn = document.getElementById('zipBrokenBtn');
    const resetBtn = document.getElementById('resetBtn');
    const log = document.getElementById('log');
    const progress = document.getElementById('progress');
    const statScanned = document.getElementById('statScanned');
    const statOK = document.getElementById('statOK');
    const statBroken = document.getElementById('statBroken');
    const statSkipped = document.getElementById('statSkipped');
    const statDup = document.getElementById('statDup');
    const statTime = document.getElementById('statTime');
    const filterCC = document.getElementById('filterCC');
    const filterScript = document.getElementById('filterScript');
    const filterZip = document.getElementById('filterZip');
    const search = document.getElementById('search');
    const statusFilter = document.getElementById('statusFilter');
    const topTableBody = document.querySelector('#topTable tbody');
    const messageBox = document.getElementById('message-box');
    document.getElementById('workerCount').textContent = WORKER_COUNT;

    // --- Laufende Daten ---
    let report = [];
    let shaMap = {};
    let startTime = 0;

    // --- Worker-Pool Setup ---
    const WORKER_CODE = `
      self.importScripts('https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js');
      async function readFirstBytes(file, len=4){
        try{ const buf = await file.slice(0,len).arrayBuffer(); return new Uint8Array(buf); }catch(e){ return null; }
      }
      async function computeSHA1(file){ try{ const buf = await file.arrayBuffer(); const hash = await crypto.subtle.digest('SHA-1', buf); return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join(''); }catch(e){ return null; } }
      async function testZip(file){ try{ const buf = await file.arrayBuffer(); await JSZip.loadAsync(buf); return true; }catch(e){ return false; } }
      self.onmessage = async (ev) => {
        const {id, relPath, file} = ev.data;
        try{
          if(file.size === 0){ postMessage({id, result:{relPath,status:'BROKEN',reason:'0-Byte',size:0,sha1:null}}); return; }
          const ext = (file.name.split('.').pop()||'').toLowerCase();
          if(!['package','ts4script','zip'].includes(ext)){ postMessage({id, result:{relPath,status:'SKIPPED',reason:'nicht unterstützt',size:file.size,sha1:null}}); return; }
          if(ext === 'package'){
            const b = await readFirstBytes(file,4);
            const ok = b && b[0]==0x44 && b[1]==0x42 && b[2]==0x50 && b[3]==0x46;
            const sha1 = await computeSHA1(file);
            if(ok) postMessage({id, result:{relPath,status:'OK',type:'CC',size:file.size,sha1}});
            else postMessage({id, result:{relPath,status:'BROKEN',reason:'keine DBPF-Signatur',size:file.size,sha1}});
            return;
          }
          if(ext==='zip' || ext==='ts4script'){
            const valid = await testZip(file);
            const sha1 = await computeSHA1(file);
            if(valid) postMessage({id, result:{relPath,status:'OK',type: ext==='ts4script'?'Script':'ZIP',size:file.size,sha1}});
            else postMessage({id, result:{relPath,status:'BROKEN',reason:'Ungültiges ZIP',size:file.size,sha1}});
            return;
          }
        }catch(e){ postMessage({id, result:{relPath,status:'BROKEN',reason:'Fehler',size:file.size,sha1:null}}); }
      };
    `;

    const workerBlobs = [];
    for(let i=0;i<WORKER_COUNT;i++){
      const blob = new Blob([WORKER_CODE], {type:'application/javascript'});
      const url = URL.createObjectURL(blob);
      workerBlobs.push(url);
    }

    function createWorker(url){
      const w = new Worker(url);
      return w;
    }

    // --- Helpers ---
    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function formatBytes(n){ if(n==null) return '—'; if(n<1024) return n+' B'; if(n<1024*1024) return (n/1024).toFixed(1)+' KB'; return (n/1024/1024).toFixed(2)+' MB'; }

    function showMessage(message, duration = 3000) {
      messageBox.textContent = message;
      messageBox.style.display = 'block';
      setTimeout(() => {
          messageBox.style.display = 'none';
      }, duration);
    }

    function copyToClipboard(text) {
      try {
        const tempInput = document.createElement('textarea');
        tempInput.value = text;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand('copy');
        document.body.removeChild(tempInput);
        showMessage('Dateiname kopiert!');
      } catch (e) {
        console.error("Kopieren in Zwischenablage fehlgeschlagen:", e);
        showMessage('Kopieren fehlgeschlagen. Bitte manuell kopieren.');
      }
    }

    function appendLog(entry){
      const div = document.createElement('div');
      if (entry.status === 'OK') {
          div.className = 'line ok';
      } else if (entry.status === 'BROKEN') {
          div.className = 'line broken';
      } else if (entry.status === 'SKIPPED') {
          div.className = 'line skipped';
      } else {
          div.className = 'line';
      }

      div.dataset.path = (entry.relPath||'').toLowerCase();
      div.dataset.status = entry.status;
      div.dataset.type = entry.type;

      const left = document.createElement('div'); 
      left.className='left';

      // Pfad aufteilen
      const lastSlashIndex = entry.relPath.lastIndexOf('/');
      const directoryPath = lastSlashIndex !== -1 ? entry.relPath.substring(0, lastSlashIndex + 1) : '';
      const fileName = lastSlashIndex !== -1 ? entry.relPath.substring(lastSlashIndex + 1) : entry.relPath;

      const metaHtml = `<div class="meta">${escapeHtml(directoryPath)}</div>`;
      const fileNameHtml = `<strong>${escapeHtml(fileName)}</strong>`;
      const metaInfoHtml = `<div class="meta">${entry.type?entry.type+' • ':''}${formatBytes(entry.size)} ${entry.sha1? '• '+entry.sha1.slice(0,12):''} ${entry.reason? '• '+entry.reason : ''}</div>`;

      left.innerHTML = `${metaHtml}${fileNameHtml}${metaInfoHtml}`;

      const right = document.createElement('div'); right.className='meta';
      if (entry.status === 'OK') {
        right.textContent = '✔';
      } else if (entry.status === 'BROKEN') {
        right.textContent = '✖';
      } else if (entry.status === 'SKIPPED') {
        const copyBtn = document.createElement('button');
        copyBtn.className = 'copy-btn';
        copyBtn.textContent = 'Kopieren';
        copyBtn.onclick = () => copyToClipboard(entry.relPath);
        right.textContent = '➖';
        right.appendChild(copyBtn);
      }
      
      div.appendChild(left); div.appendChild(right);
      log.appendChild(div);
    }

    function updateStats(){
      statScanned.textContent = report.length;
      statOK.textContent = report.filter(r=>r.status==='OK').length;
      statBroken.textContent = report.filter(r=>r.status==='BROKEN').length;
      statSkipped.textContent = report.filter(r=>r.status==='SKIPPED').length;
      const dupCount = Object.values(shaMap).filter(a=>a.length>1).reduce((s,a)=>s+a.length,0);
      statDup.textContent = dupCount;
      const elapsed = startTime ? Math.round((Date.now()-startTime)/1000) : 0;
      statTime.textContent = elapsed + 's';
    }

    function refreshTopList(){
      const rows = report.filter(r=>r.size>0).sort((a,b)=>b.size-a.size).slice(0,10);
      topTableBody.innerHTML='';
      for(const r of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(r.relPath)}</td><td class="mono">${formatBytes(r.size)}</td><td class="mono">${r.sha1? r.sha1.slice(0,12):'—'}</td>`;
        topTableBody.appendChild(tr);
      }
    }

    function applyLiveFilter(){
      const q = (search.value || '').toLowerCase();
      const status = statusFilter.value;
      const filterCC_checked = filterCC.checked;
      const filterScript_checked = filterScript.checked;
      const filterZip_checked = filterZip.checked;

      Array.from(log.children).forEach(div => {
        const pathMatch = (div.dataset.path || '').includes(q);
        const statusMatch = (status === 'all' || div.dataset.status === status.toUpperCase());

        let typeMatch = true;
        if (div.dataset.status === 'OK') {
          typeMatch = (div.dataset.type === 'CC' && filterCC_checked) ||
                      (div.dataset.type === 'Script' && filterScript_checked) ||
                      (div.dataset.type === 'ZIP' && filterZip_checked);
        }

        div.style.display = (pathMatch && statusMatch && typeMatch) ? '' : 'none';
      });
    }

    // --- Scan using worker pool ---
    scanBtn.onclick = async ()=>{
      const files = Array.from(fileInput.files || []);
      if(files.length===0){ showMessage('Bitte Dateien/Ordner wählen!'); return; }
      if(files.length>MAX_FILES){ showMessage('Max '+MAX_FILES+' Dateien erlaubt.'); return; }

      // reset
      report = []; shaMap = {}; log.innerHTML='Das Protokoll wird hier angezeigt...'; progress.style.display='block'; progress.value=0; startTime = Date.now(); updateStats(); refreshTopList();
      zipBtn.disabled = true; // Zuerst deaktivieren
      zipBrokenBtn.disabled = true;
      progress.classList.add('animated-progress'); // Animation starten

      // prepare workers
      const workerPool = [];
      const idle = [];
      let nextId = 0;
      const pending = new Map();
      let completed = 0;

      for(let i=0;i<WORKER_COUNT;i++){
        const w = createWorker(workerBlobs[i]);
        w.onmessage = (ev)=>{
          const {id, result} = ev.data;
          const resolveData = pending.get(id);
          if(resolveData){
            pending.delete(id);
            handleResult(result);
            idle.push(w);
            schedule();
          }
        };
        workerPool.push(w); idle.push(w);
      }

      function handleResult(res){
        const f = files.find(ff => (ff.webkitRelativePath||ff.name) === res.relPath);
        res.fileObj = f || null;
        report.push(res);
        if(res.sha1){ shaMap[res.sha1] = shaMap[res.sha1] || []; shaMap[res.sha1].push(res); }
        appendLog(res);
        completed++; progress.value = Math.round((completed/files.length)*100);
        updateStats(); refreshTopList();
      }

      let idx = 0;
      function schedule(){
        while(idle.length>0 && idx<files.length){
          const w = idle.shift();
          const f = files[idx++];
          const rel = f.webkitRelativePath || f.name;

          const id = ++nextId;
          pending.set(id, {fileName:rel});
          w.postMessage({id, relPath: rel, file: f});
        }
        if(completed === files.length){
          workerPool.forEach(w=>w.terminate());
          progress.classList.remove('animated-progress'); // Animation stoppen
          progress.style.display='none';
          const totalSec = Math.round((Date.now()-startTime)/1000);
          statTime.textContent = totalSec + 's';
          log.insertAdjacentHTML('beforeend', `<div class="line summary">Scan beendet — Dauer: <strong>${totalSec}s</strong></div>`);
          markDuplicates(); updateStats();
          zipBtn.disabled = report.filter(r=>r.status === 'OK').length === 0; // Jetzt aktivieren!
          zipBrokenBtn.disabled = report.filter(r=>r.status === 'BROKEN').length === 0;
        }
      }

      function markDuplicates(){
        let dups = 0;
        Object.entries(shaMap).forEach(([sha, arr])=>{
          if(arr.length>1){ dups += arr.length; arr.forEach(item=>{
            const nodes = Array.from(log.children).filter(n=>n.dataset.path === (item.relPath||'').toLowerCase());
            nodes.forEach(n=>{ const badge = document.createElement('span'); badge.className='meta'; badge.style.marginLeft='8px'; badge.style.color='#ffd166'; badge.textContent=' DUP'; n.querySelector('.left').appendChild(badge); });
          }); }
        });
        statDup.textContent = dups;
      }
      schedule();
    };

    zipBtn.onclick = async ()=>{
      showMessage('Erstelle ZIP-Datei...', 99999);
      const zip = new JSZip();
      let filesAdded = 0;
      for(const entry of report){
        if(entry.status !== 'OK') continue;
        if(entry.type==='CC' && !filterCC.checked) continue;
        if(entry.type==='Script' && !filterScript.checked) continue;
        if(entry.type==='ZIP' && !filterZip.checked) continue;
        if(!entry.fileObj){ console.warn(`Skipping file due to missing fileObj: ${entry.relPath}`); continue; }
        try{ const buf = await entry.fileObj.arrayBuffer(); zip.file(entry.relPath, buf); filesAdded++; }catch(e){console.warn('Zip add error', entry.relPath, e);}
      }
      if(filesAdded === 0){ showMessage('Keine Mods für den Download ausgewählt.'); return; }
      const blob = await zip.generateAsync({type:'blob'});
      const u = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = u; a.download = 'CleanMods.zip'; a.click(); URL.revokeObjectURL(u);
      showMessage(`Download von ${filesAdded} Mods ausgelöst!`);
    };

    zipBrokenBtn.onclick = async () => {
        showMessage('Erstelle ZIP-Datei...', 99999);
        const zip = new JSZip();
        let filesAdded = 0;
        const brokenMods = report.filter(r => r.status === 'BROKEN');
        if (brokenMods.length === 0) {
            showMessage('Keine BROKEN Mods zum Zippen gefunden.');
            return;
        }
        for (const entry of brokenMods) {
            if(!entry.fileObj){ console.warn(`Skipping broken file due to missing fileObj: ${entry.relPath}`); continue; }
            try {
                const buf = await entry.fileObj.arrayBuffer();
                zip.file(entry.relPath, buf);
                filesAdded++;
            } catch (e) {
                console.warn('Zip add error', entry.relPath, e);
            }
        }
        if(filesAdded === 0){ showMessage('Keine BROKEN Mods für den Download gefunden.'); return; }
        const blob = await zip.generateAsync({ type: 'blob' });
        const u = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = u;
        a.download = 'BrokenMods.zip';
        a.click();
        URL.revokeObjectURL(u);
        showMessage(`Download von ${filesAdded} fehlerhaften Mods ausgelöst!`);
    };

    resetBtn.onclick = ()=>{ fileInput.value=''; report=[]; shaMap={}; log.innerHTML='Das Protokoll wird hier angezeigt...'; topTableBody.innerHTML=''; updateStats(); zipBtn.disabled = true; zipBrokenBtn.disabled = true; };
    search.addEventListener('input', applyLiveFilter);
    statusFilter.addEventListener('change', applyLiveFilter);
    filterCC.addEventListener('change', applyLiveFilter);
    filterScript.addEventListener('change', applyLiveFilter);
    filterZip.addEventListener('change', applyLiveFilter);
    document.querySelector('.dropzone').addEventListener('click', ()=> fileInput.click());

  } catch (error) {
    // Anzeigen einer Fehlermeldung auf der Seite, falls das Skript fehlschlägt
    document.body.innerHTML = `
      <div style="background: #e74c3c; color: white; padding: 20px; border-radius: 10px; text-align: center; font-size: 18px;">
        <h2>Unerwarteter Fehler</h2>
        <p>Ein Fehler ist beim Laden der Anwendung aufgetreten. Bitte versuche es erneut.</p>
        <p>Details: ${error.message}</p>
      </div>
    `;
    console.error("Fataler Startfehler:", error);
  }
  </script>
</body>
</html>

<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sims 4 Mod Checker — Dark UI</title>
  <style>
    body {font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background: #0d1117; color: #e6edf3; display: flex; justify-content: center; align-items: center; min-height: 100vh;}
    .container {background: #161b22; padding: 32px 24px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.6); max-width: 700px; width: 100%; text-align: center; box-sizing: border-box;}
    h1 {font-size: 28px; margin: 0; color: #2ecc71;}
    p {margin: 6px 0 20px; color: #8b949e;}

    .plumbob {width: 60px; height: 90px; animation: spin 4s linear infinite; margin: 0 auto 20px; display: block;}
    @keyframes spin {from{transform:rotateY(0deg);} to{transform:rotateY(360deg);}}

    .dropzone {border: 2px dashed #30363d; border-radius: 12px; padding: 32px 16px; margin: 20px 0; color: #8b949e; cursor: pointer; display:block;}
    .dropzone:hover {border-color: #2ecc71; color: #2ecc71;}

    .row {display: flex; justify-content: center; gap: 16px; flex-wrap: nowrap; margin-top: 20px;}
    button {flex: 1; min-width: 0; padding: 14px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s;}
    button.primary {background: #2ecc71; color: #fff;}
    button.primary:hover {background: #27ae60;}
    button.secondary {background: #3498db; color: #fff;}
    button.secondary:hover {background: #2980b9;}
    button.danger {background: #7f8c8d; color: #fff;}
    button.danger:hover {background: #95a5a6;}
    button:disabled {opacity: 0.5; cursor: not-allowed;}

    #log {background: #0d1117; border: 1px solid #30363d; border-radius: 8px; padding: 12px; margin-top: 20px; font-size: 13px; color: #8b949e; text-align: left; max-height: 220px; overflow-y: auto;}
    #log .ok {color: #2ecc71;}
    #log .broken {color: #e74c3c;}
    #log .skipped {color: #95a5a6;}
    #log .cc {color: #1abc9c;}
    #log .summary {margin-top: 8px; font-weight: bold;}
    #log .summary .ok {color: #2ecc71;}
    #log .summary .broken {color: #e74c3c;}
    #log .summary .skipped {color: #95a5a6;}

    progress {width: 100%; height: 16px; border-radius: 8px; overflow: hidden; margin-top: 16px;}
    progress::-webkit-progress-bar {background: #30363d;}
    progress::-webkit-progress-value {background: #2ecc71;}
    progress::-moz-progress-bar {background: #2ecc71;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</head>
<body>
  <div class="container">
    <svg class="plumbob" viewBox="0 0 100 150" xmlns="http://www.w3.org/2000/svg">
      <polygon points="50,0 0,75 50,150 100,75" fill="#2ecc71" stroke="#145a32" stroke-width="2"/>
    </svg>
    <h1>Sims 4 Mod Checker</h1>
    <p>Lade deine Mods hoch, um sie zu überprüfen und eine saubere ZIP-Datei zu erstellen.</p>

    <label class="dropzone" for="fileInput">
      Zieh deinen <strong>Mods-Ordner</strong> hierher (inkl. Unterordner)<br>
      <small>oder klicke, um den Ordner auszuwählen</small>
    </label>
    <input id="fileInput" type="file" webkitdirectory directory multiple style="display:none" />

    <div class="row">
      <button id="scanBtn" class="primary">1. Mods Scannen</button>
      <button id="zipBtn" class="secondary" disabled>2. Funktionierende Mods als ZIP packen</button>
      <button id="resetBtn" class="danger">Zurücksetzen</button>
    </div>

    <progress id="progress" value="0" max="100" style="display:none"></progress>
    <div id="log">Das Protokoll wird hier angezeigt...</div>
  </div>

  <script>
    const fileInput=document.getElementById('fileInput');
    const scanBtn=document.getElementById('scanBtn');
    const zipBtn=document.getElementById('zipBtn');
    const resetBtn=document.getElementById('resetBtn');
    const log=document.getElementById('log');
    const progress=document.getElementById('progress');

    const SUPPORTED=['.package','.ts4script','.zip'];
    const MAX_FILES=4000;
    let report=[],zipBlob=null;

    function logMsg(msg,cls=""){log.innerHTML+=`<div class="${cls}">${msg}</div>`;log.scrollTop=log.scrollHeight;}

    function resetAll(){fileInput.value="";report=[];zipBlob=null;zipBtn.disabled=true;progress.style.display="none";log.innerHTML="Das Protokoll wird hier angezeigt...";}

    function readFirstBytes(file,len=4){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(new Uint8Array(r.result));r.onerror=()=>rej(r.error);r.readAsArrayBuffer(file.slice(0,len));});}

    async function testZip(file){try{const buf=await file.arrayBuffer();await JSZip.loadAsync(buf);return true;}catch{return false;}}

    async function classify(file){
      if(file.size===0) return {status:'BROKEN',reason:'0-Byte'};
      const ext=(file.name.split('.').pop()||'').toLowerCase();
      if(!SUPPORTED.includes('.'+ext))return{status:'SKIPPED',reason:'nicht unterstützt'};
      if(ext==='package'){
        try{
          const b=await readFirstBytes(file,4);
          return(b[0]==0x44&&b[1]==0x42&&b[2]==0x50&&b[3]==0x46)?{status:'OK',cc:true}:{status:'BROKEN',reason:'keine DBPF-Signatur'};
        }catch{return{status:'BROKEN',reason:'Lesefehler'}}
      }
      if(ext==='zip'||ext==='ts4script'){
        return(await testZip(file))?{status:'OK'}:{status:'BROKEN',reason:'Ungültiges ZIP'}}
      return{status:'SKIPPED',reason:'Unhandled'};
    }

    scanBtn.onclick=async()=>{
      const files=Array.from(fileInput.files);
      if(files.length===0){alert('Bitte Dateien wählen!');return;}
      if(files.length>MAX_FILES){alert('Max '+MAX_FILES+' Dateien erlaubt.');return;}

      report=[];log.innerHTML='';progress.style.display='block';progress.value=0;
      const zip=new JSZip();let ok=0,broken=0,skipped=0;

      for(let i=0;i<files.length;i++){
        const f=files[i];
        const relPath=f.webkitRelativePath||f.name;
        try{
          const r=await classify(f);
          report.push({file:relPath,...r});
          if(r.status==='OK'){
            ok++;
            zip.file(relPath,await f.arrayBuffer());
            if(r.cc){
              logMsg(`✔ ${relPath} — OK (CC erkannt)`,`cc`);
            }else{
              logMsg(`✔ ${relPath} — OK`,`ok`);
            }
          }else if(r.status==='BROKEN'){
            broken++;logMsg(`✖ ${relPath} — ${r.reason}`,'broken');
          }else{
            skipped++;logMsg(`➖ ${relPath} — ${r.reason}`,'skipped');
          }
        }catch{
          broken++;logMsg(`✖ ${relPath} — Fehler beim Prüfen`,'broken');
        }
        progress.value=Math.round(((i+1)/files.length)*100);
      }

      logMsg(`<div class="summary">Fertig. <span class="ok">OK: ${ok}</span>, <span class="broken">BROKEN: ${broken}</span>, <span class="skipped">SKIPPED: ${skipped}</span></div>`);
      zipBlob=await zip.generateAsync({type:'blob'});zipBtn.disabled=false;
    };

    zipBtn.onclick=()=>{if(!zipBlob)return;const u=URL.createObjectURL(zipBlob);const a=document.createElement('a');a.href=u;a.download='CleanMods.zip';a.click();URL.revokeObjectURL(u);};
    resetBtn.onclick=()=>resetAll();
  </script>
</body>
</html>
